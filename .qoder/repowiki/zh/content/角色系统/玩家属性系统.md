# ç©å®¶å±æ€§ç³»ç»Ÿ

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [src/data/player.js](file://src/data/player.js)
- [src/components/PlayerStatusPanel.vue](file://src/components/PlayerStatusPanel.vue)
- [src/components/PlayerBasicStats.vue](file://src/components/PlayerBasicStats.vue)
- [src/data/unit.js](file://src/data/unit.js)
- [src/data/effectProcessor.js](file://src/data/effectProcessor.js)
- [src/data/battleUtils.js](file://src/data/battleUtils.js)
- [src/data/battle.js](file://src/data/battle.js)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„æ¦‚è§ˆ](#é¡¹ç›®ç»“æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒå±æ€§è®¾è®¡](#æ ¸å¿ƒå±æ€§è®¾è®¡)
4. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [å±æ€§åŠ¨æ€å˜åŒ–æœºåˆ¶](#å±æ€§åŠ¨æ€å˜åŒ–æœºåˆ¶)
7. [UIæ•°æ®ç»‘å®š](#uiæ•°æ®ç»‘å®š)
8. [Effectsç³»ç»Ÿé›†æˆ](#effectsç³»ç»Ÿé›†æˆ)
9. [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)
10. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
11. [ç»“è®º](#ç»“è®º)

## ç®€ä»‹

ç©å®¶å±æ€§ç³»ç»Ÿæ˜¯æ¸¸æˆã€ŠWeKyspireã€‹çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£ç®¡ç†ç©å®¶åœ¨æˆ˜æ–—ä¸­çš„å„ç§åŸºç¡€å±æ€§ï¼ŒåŒ…æ‹¬ç”Ÿå‘½å€¼ã€æŠ¤ç›¾ã€æ³•åŠ›å€¼ã€è¡ŒåŠ¨ç‚¹ç­‰å…³é”®å‚æ•°ã€‚è¯¥ç³»ç»Ÿé‡‡ç”¨é¢å‘å¯¹è±¡çš„è®¾è®¡æ¨¡å¼ï¼Œç»“åˆVue.jsçš„å“åº”å¼ç‰¹æ€§ï¼Œå®ç°äº†å±æ€§çš„å®æ—¶æ›´æ–°å’ŒåŠ¨æ€å˜åŒ–ã€‚

ç³»ç»Ÿçš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š
- åŸºäºUnitç±»çš„å±æ€§ç»§æ‰¿æœºåˆ¶
- æ”¯æŒå±æ€§ä¿®æ­£å™¨çš„çµæ´»æ‰©å±•
- å®Œæ•´çš„Effectsç³»ç»Ÿé›†æˆ
- å®æ—¶çš„UIæ•°æ®ç»‘å®š
- è¾¹ç•Œå€¼ä¿æŠ¤å’Œå¼‚å¸¸å¤„ç†

## é¡¹ç›®ç»“æ„æ¦‚è§ˆ

```mermaid
graph TB
subgraph "æ•°æ®å±‚"
Player[Playerç±»]
Unit[UnitåŸºç±»]
Effects[Effectsç³»ç»Ÿ]
end
subgraph "UIå±‚"
StatusPanel[PlayerStatusPanel]
BasicStats[PlayerBasicStats]
HealthBar[HealthBar]
ManaBar[ManaBar]
ActionPoints[ActionPointsBar]
end
subgraph "å·¥å…·å±‚"
BattleUtils[æˆ˜æ–—å·¥å…·]
EffectProcessor[æ•ˆæœå¤„ç†å™¨]
Battle[Battleé€»è¾‘]
end
Player --> Unit
Player --> Effects
Player --> BattleUtils
StatusPanel --> Player
BasicStats --> Player
HealthBar --> Player
ManaBar --> Player
ActionPoints --> Player
BattleUtils --> Effects
Battle --> Player
```

**å›¾è¡¨æ¥æº**
- [src/data/player.js](file://src/data/player.js#L1-L226)
- [src/data/unit.js](file://src/data/unit.js#L1-L44)

**ç« èŠ‚æ¥æº**
- [src/data/player.js](file://src/data/player.js#L1-L226)
- [src/data/unit.js](file://src/data/unit.js#L1-L44)

## æ ¸å¿ƒå±æ€§è®¾è®¡

### åŸºç¡€å±æ€§ç»“æ„

Playerç±»ç»§æ‰¿è‡ªUnitç±»ï¼Œå®ç°äº†å®Œæ•´çš„å±æ€§ç®¡ç†ç³»ç»Ÿï¼š

```javascript
// ç”Ÿå‘½å€¼ç›¸å…³å±æ€§
this.hp = 65;           // å½“å‰ç”Ÿå‘½å€¼
this.maxHp = 65;        // æœ€å¤§ç”Ÿå‘½å€¼
this.shield = 0;        // å½“å‰æŠ¤ç›¾å€¼

// èµ„æºå±æ€§
this.mana = 0;          // å½“å‰é­å¯å€¼
this.maxMana = 0;       // æœ€å¤§é­å¯å€¼
this.remainingActionPoints = 3;  // å½“å‰è¡ŒåŠ¨ç‚¹
this.maxActionPoints = 3;        // æœ€å¤§è¡ŒåŠ¨ç‚¹

// åŸºç¡€å±æ€§
this.baseAttack = 0;    // åŸºç¡€æ”»å‡»åŠ›
this.baseMagic = 1;     // åŸºç¡€çµèƒ½å¼ºåº¦
this.baseDefense = 0;   // åŸºç¡€é˜²å¾¡åŠ›

// ç­‰é˜¶ç³»ç»Ÿ
this.tier = 1;          // ç©å®¶ç­‰é˜¶ï¼Œé»˜è®¤ä¸ºè§ä¹ çµå¾¡
```

### å±æ€§è®¡ç®—æœºåˆ¶

ç³»ç»Ÿé€šè¿‡getteræ–¹æ³•å®ç°å±æ€§çš„åŠ¨æ€è®¡ç®—ï¼š

```javascript
// æ”»å‡»åŠ›è®¡ç®—ï¼ˆåŸºç¡€æ”»å‡» + åŠ›é‡æ•ˆæœï¼‰
get attack() {
  return this.baseAttack + (this.effects['åŠ›é‡'] || 0);
}

// é˜²å¾¡åŠ›è®¡ç®—ï¼ˆåŸºç¡€é˜²å¾¡ + åšå›ºæ•ˆæœï¼‰
get defense() {
  return this.baseDefense + (this.effects['åšå›º'] || 0);
}

// çµèƒ½å¼ºåº¦è®¡ç®—ï¼ˆåŸºç¡€çµèƒ½ + é›†ä¸­æ•ˆæœï¼‰
get magic() {
  return this.baseMagic + (this.effects['é›†ä¸­'] || 0);
}
```

### å±æ€§ä¿®æ­£ç³»ç»Ÿ

ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„å±æ€§ä¿®æ­£å™¨æœºåˆ¶ï¼š

```javascript
// åˆ›å»ºå±æ€§ä¿®æ­£å™¨å·¥å‚å‡½æ•°
export function createPlayerStatModifier({ attack, defense, magic } = {}) {
  return function(player) {
    return new Proxy(player, {
      get(target, prop, receiver) {
        if (prop === 'attack') {
          const base = Reflect.get(target, 'attack', receiver);
          return typeof attack === 'function' ? attack(base, receiver) : base;
        }
        // ç±»ä¼¼çš„é˜²å¾¡å’Œçµèƒ½ä¿®æ­£...
        return Reflect.get(target, prop, receiver);
      }
    });
  }
}
```

**ç« èŠ‚æ¥æº**
- [src/data/player.js](file://src/data/player.js#L60-L120)
- [src/data/unit.js](file://src/data/unit.js#L15-L35)

## æ¶æ„æ¦‚è§ˆ

```mermaid
classDiagram
class Unit {
+string type
+string name
+number hp
+number maxHp
+number shield
+number baseAttack
+number baseDefense
+number baseMagic
+object effects
+get attack() number
+get defense() number
+get magic() number
+addEffect(name, stacks) void
+removeEffect(name, stacks) void
+hasEffect(name) boolean
}
class Player {
+number mana
+number maxMana
+number remainingActionPoints
+number maxActionPoints
+number money
+number tier
+array cultivatedSkills
+array frontierSkills
+array backupSkills
+array burntSkills
+object leinoFactors
+array abilities
+array modifiers
+boolean modified
+addLeino(type, value) void
+getLeinoWeight(type) number
+addModifier(modifierFn) void
+removeModifier(modifierFn) void
+getModifiedPlayer() Player
+consumeActionPoints(amount) void
+consumeMana(amount) void
+gainMana(amount) void
+gainActionPoint(amount) void
}
class PlayerStatusPanel {
+object player
+boolean restScreen
+playLevelUpAnimation() void
+spawnGoldenParticles() void
+getPlayerPanelTierStyle() object
}
class PlayerBasicStats {
+object player
+boolean showMana
+spawnTextParticle(text, element, color) void
+triggerStatBump(element) void
}
Unit <|-- Player
Player --> PlayerStatusPanel : "æ˜¾ç¤º"
Player --> PlayerBasicStats : "æ•°æ®ç»‘å®š"
```

**å›¾è¡¨æ¥æº**
- [src/data/unit.js](file://src/data/unit.js#L6-L44)
- [src/data/player.js](file://src/data/player.js#L60-L150)
- [src/components/PlayerStatusPanel.vue](file://src/components/PlayerStatusPanel.vue#L20-L50)
- [src/components/PlayerBasicStats.vue](file://src/components/PlayerBasicStats.vue#L15-L40)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### Playerç±»æ ¸å¿ƒåŠŸèƒ½

Playerç±»ä½œä¸ºç©å®¶å±æ€§ç®¡ç†çš„æ ¸å¿ƒï¼Œå®ç°äº†ä»¥ä¸‹å…³é”®åŠŸèƒ½ï¼š

#### å±æ€§åˆå§‹åŒ–ä¸è¾¹ç•Œå¤„ç†

```javascript
// å±æ€§è¾¹ç•Œä¿æŠ¤æœºåˆ¶
consumeMana(amount) {
  this.mana -= amount;
  this.mana = Math.max(this.mana, 0);      // ç¡®ä¿ä¸å°äº0
  this.mana = Math.min(this.mana, this.maxMana); // ç¡®ä¿ä¸è¶…è¿‡æœ€å¤§å€¼
}

gainMana(amount) {
  this.mana += amount;
  this.mana = Math.max(this.mana, 0);
  this.mana = Math.min(this.mana, this.maxMana);
}

gainActionPoint(amount) {
  this.remainingActionPoints += amount;
  this.remainingActionPoints = Math.min(this.remainingActionPoints, this.maxActionPoints);
}
```

#### ç­‰é˜¶ç³»ç»Ÿä¸å‡çº§æœºåˆ¶

```javascript
// ç­‰é˜¶å‡çº§é€»è¾‘
export function upgradePlayerTier(player) {
  const nextTier = getNextPlayerTier(player.tier);
  if (nextTier !== undefined) {
    player.tier = nextTier;
    if (player.tier === 1) {
      // ç‰¹æ®Šï¼šç¬¬ä¸€æ¬¡å‡çº§æ—¶ç»™5é­å¯ä¸Šé™
      player.maxMana = 5;
    }
    if (player.maxActionPoints < 4) {
      player.maxActionPoints++;
    }
  }
  player.hp = player.maxHp;
  player.mana = player.maxMana;
  backendEventBus.emit(EventNames.Player.TIER_UPGRADED, player);
  return true;
}
```

#### çµè„‰ç³»ç»Ÿ

```javascript
// çµè„‰å› å­ç®¡ç†
addLeino(type, value) {
  if (this.leinoFactors[type]) {
    this.leinoFactors[type] += value;
  } else {
    this.leinoFactors[type] = value;
  }
}

getLeinoWeight(type) {
  return Math.max(this.leinoFactors[type] || 0, 0);
}

getAllLeinoWeight() {
  return Object.values(this.leinoFactors).reduce((sum, val) => sum + val, 0);
}
```

### PlayerStatusPanelç»„ä»¶

PlayerStatusPanelæ˜¯ç©å®¶çŠ¶æ€é¢æ¿çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£å±•ç¤ºç©å®¶çš„æ•´ä½“çŠ¶æ€ï¼š

```vue
<template>
  <div class="player-status-panel">
    <PlayerBasicStats :player="player" :show-mana="restScreen" />
    <ManaBar :player="player" />
    <ActionPointsBar :player="player" v-if="!restScreen" />
    <EffectDisplayBar :effects="player.effects" :target="player" />
    <HealthBar :unit="player" />
  </div>
</template>
```

è¯¥ç»„ä»¶å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š
- æ”¯æŒä¼‘æ¯æ¨¡å¼å’Œæˆ˜æ–—æ¨¡å¼çš„ä¸åŒæ ·å¼
- å®ç°äº†ç­‰é˜¶å‡çº§çš„è§†è§‰åŠ¨ç”»æ•ˆæœ
- é›†æˆäº†ç²’å­æ•ˆæœç³»ç»Ÿ

### PlayerBasicStatsç»„ä»¶

PlayerBasicStatsä¸“é—¨è´Ÿè´£å±•ç¤ºç©å®¶çš„åŸºæœ¬ç»Ÿè®¡æ•°æ®ï¼š

```vue
<template>
  <div class="player-stats">
    <div class="stat">
      <span class="stat-label">ğŸ’° é‡‘é’±:</span>
      <span class="stat-value">{{ player.money }}</span>
    </div>
    <div class="stat">
      <span class="stat-label">ğŸ”® çµèƒ½:</span>
      <span class="stat-value">{{ player.magic }}</span>
    </div>
    <div class="stat">
      <span class="stat-label">ğŸ›¡ï¸ é˜²å¾¡:</span>
      <span class="stat-value">{{ player.defense }}</span>
    </div>
    <div class="stat">
      <span class="stat-label">ğŸ… ç­‰é˜¶:</span>
      <span class="stat-value">{{ getPlayerTierLabel(player.tier) }}</span>
    </div>
  </div>
</template>
```

**ç« èŠ‚æ¥æº**
- [src/data/player.js](file://src/data/player.js#L150-L226)
- [src/components/PlayerStatusPanel.vue](file://src/components/PlayerStatusPanel.vue#L1-L50)
- [src/components/PlayerBasicStats.vue](file://src/components/PlayerBasicStats.vue#L1-L50)

## å±æ€§åŠ¨æ€å˜åŒ–æœºåˆ¶

### è¡ŒåŠ¨ç‚¹ç³»ç»Ÿ

è¡ŒåŠ¨ç‚¹æ˜¯æˆ˜æ–—ä¸­æœ€é‡è¦çš„èµ„æºä¹‹ä¸€ï¼Œç³»ç»Ÿå®ç°äº†å®Œæ•´çš„è¡ŒåŠ¨ç‚¹ç®¡ç†æœºåˆ¶ï¼š

```javascript
// è¡ŒåŠ¨ç‚¹æ¶ˆè€—æœºåˆ¶
consumeActionPoints(amount) {
  this.remainingActionPoints -= amount;
  this.remainingActionPoints = Math.max(this.remainingActionPoints, 0);
}

// è¡ŒåŠ¨ç‚¹è¡¥å……æœºåˆ¶
gainActionPoint(amount) {
  this.remainingActionPoints += amount;
  this.remainingActionPoints = Math.min(this.remainingActionPoints, this.maxActionPoints);
}
```

### æ³•åŠ›å€¼ç³»ç»Ÿ

é­å¯å€¼ï¼ˆManaï¼‰ç³»ç»Ÿæ”¯æŒç²¾ç¡®çš„èµ„æºç®¡ç†å’Œè¾¹ç•Œä¿æŠ¤ï¼š

```javascript
// æ³•åŠ›å€¼æ¶ˆè€—ä¸è¡¥å……
consumeMana(amount) {
  this.mana -= amount;
  this.mana = Math.max(this.mana, 0);
  this.mana = Math.min(this.mana, this.maxMana);
}

gainMana(amount) {
  this.mana += amount;
  this.mana = Math.max(this.mana, 0);
  this.mana = Math.min(this.mana, this.maxMana);
}
```

### ç”Ÿå‘½å€¼ä¸æŠ¤ç›¾ç³»ç»Ÿ

ç”Ÿå‘½å€¼å’ŒæŠ¤ç›¾ç³»ç»Ÿå®ç°äº†å¤æ‚çš„ä¼¤å®³å‡å…æœºåˆ¶ï¼š

```javascript
// ä¼¤å®³ç»“ç®—é€»è¾‘
function applyDamageAndLog(target, mitigatedDamage, options = {}) {
  const passThoughDamage = mitigatedDamage;
  let hpDamage = 0;

  if (mitigatedDamage > 0) {
    // å…ˆæ‰“æŠ¤ç›¾
    const shieldDamage = Math.min(target.shield, mitigatedDamage);
    mitigatedDamage -= shieldDamage;
    hpDamage = mitigatedDamage;

    // æ›´æ–°ç”Ÿå‘½å€¼çŠ¶æ€
    target.shield -= shieldDamage;
    target.hp = Math.max(target.hp - mitigatedDamage, 0);
  }
}
```

### å±æ€§ä¿®æ­£å™¨ç³»ç»Ÿ

ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„å±æ€§ä¿®æ­£å™¨æœºåˆ¶ï¼Œå…è®¸åŠ¨æ€ä¿®æ”¹å±æ€§å€¼ï¼š

```javascript
// å±æ€§ä¿®æ­£å™¨åº”ç”¨æµç¨‹
getModifiedPlayer() {
  if(this.modified) return this; // å·²ç»æ˜¯ä¿®æ­£è¿‡çš„ï¼Œç›´æ¥è¿”å›
  
  let current = this;
  for (const mod of this.modifiers) {
    try {
      const next = mod(current);
      if (next) current = next;
    } catch (e) {
      console.warn('åº”ç”¨å±æ€§ä¿®æ­£å™¨æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå·²è·³è¿‡ï¼š', e);
    }
  }
  
  // æœ€åä¸€ä¸ªä¿®æ­£ï¼šæ ‡è®°ä¸ºå·²ä¿®æ­£
  if (!current.modified) {
    current = new Proxy(current, {
      get(target, prop, receiver) {
        if (prop === 'modified') return true;
        return Reflect.get(target, prop, receiver);
      }
    });
  }
  return current;
}
```

**ç« èŠ‚æ¥æº**
- [src/data/player.js](file://src/data/player.js#L180-L226)
- [src/data/battleUtils.js](file://src/data/battleUtils.js#L10-L50)

## UIæ•°æ®ç»‘å®š

### Vue.jså“åº”å¼æœºåˆ¶

ç³»ç»Ÿå……åˆ†åˆ©ç”¨Vue.jsçš„å“åº”å¼ç‰¹æ€§å®ç°æ•°æ®ç»‘å®šï¼š

```javascript
// PlayerBasicStatsä¸­çš„å“åº”å¼ç›‘å¬
watch: {
  player: {
    handler(newPlayer) {
      // ç›‘å¬é‡‘é’±å˜åŒ–
      if (newPlayer.money !== this.previousPlayer.money) {
        const diff = newPlayer.money - this.previousPlayer.money;
        const moneyStat = this.$el.querySelector('.stat:nth-child(1)');
        if (moneyStat) {
          const text = diff > 0 ? `+${diff}ğŸ’°` : `${diff}ğŸ’°`;
          this.spawnTextParticle(text, moneyStat, diff > 0 ? '#4caf50' : '#f44336');
          this.triggerStatBump(moneyStat);
        }
      }
      
      // ç›‘å¬é˜²å¾¡åŠ›å˜åŒ–
      if (newPlayer.defense !== this.previousPlayer.defense) {
        const diff = newPlayer.defense - this.previousPlayer.defense;
        const defenseStat = this.$el.querySelector('.stat:nth-child(3)');
        if (defenseStat) {
          const text = diff > 0 ? `+${diff}ğŸ›¡ï¸` : `${diff}ğŸ›¡ï¸`;
          this.spawnTextParticle(text, defenseStat, diff > 0 ? '#9c27b0' : '#f44336');
          this.triggerStatBump(defenseStat);
        }
      }
    },
    deep: true
  }
}
```

### åŠ¨ç”»ä¸è§†è§‰åé¦ˆ

ç³»ç»Ÿå®ç°äº†ä¸°å¯Œçš„è§†è§‰åé¦ˆæœºåˆ¶ï¼š

```javascript
// æ•°å€¼å˜åŒ–çš„ç²’å­æ•ˆæœ
spawnTextParticle(text, statElement, color = '#ffffff') {
  const rect = statElement.getBoundingClientRect();
  const particles = [{
    x: rect.left + rect.width / 2,
    y: rect.top,
    vx: (Math.random() - 0.5) * 0.5,
    vy: -80,
    size: 14,
    life: 2000,
    gravity: 0,
    fade: true,
    text: text,
    extraStyles: {
      color: color,
      fontWeight: 'bold',
      width: 'auto',
      fontSize: '20px'
    }
  }];
  
  frontendEventBus.emit('spawn-particles', particles);
}

// ç¼©æ”¾åŠ¨ç”»æ•ˆæœ
triggerStatBump(statElement) {
  if (!statElement) return;
  statElement.classList.remove('stat-bump');
  statElement.offsetWidth; // å¼ºåˆ¶å›æµ
  statElement.classList.add('stat-bump');
  
  const handler = () => {
    statElement.classList.remove('stat-bump');
    statElement.removeEventListener('animationend', handler);
  };
  statElement.addEventListener('animationend', handler);
}
```

### ç­‰é˜¶å‡çº§åŠ¨ç”»

PlayerStatusPanelå®ç°äº†ç‹¬ç‰¹çš„ç­‰é˜¶å‡çº§åŠ¨ç”»ï¼š

```javascript
playLevelUpAnimation() {
  if (!this.restScreen) return;
  
  // é¢œè‰²æ¸å˜åŠ¨ç”»
  const panel = this.$el.querySelector('.player-status-panel');
  if (panel) {
    const originalColor = this.getPlayerPanelTierStyle(this.player.tier).major;
    
    // é—ªçƒæ•ˆæœ
    panel.style.transition = 'background-color 0.5s ease';
    panel.style.backgroundColor = '#ffffff';
    
    setTimeout(() => {
      panel.style.backgroundColor = originalColor;
    }, 250);
    
    setTimeout(() => {
      panel.style.backgroundColor = '#ffffff';
    }, 500);
    
    setTimeout(() => {
      panel.style.backgroundColor = originalColor;
      panel.style.transition = '';
    }, 750);
  }
  
  // é‡‘è‰²ç²’å­æ•ˆæœ
  this.spawnGoldenParticles();
}
```

**ç« èŠ‚æ¥æº**
- [src/components/PlayerBasicStats.vue](file://src/components/PlayerBasicStats.vue#L70-L120)
- [src/components/PlayerStatusPanel.vue](file://src/components/PlayerStatusPanel.vue#L60-L120)

## Effectsç³»ç»Ÿé›†æˆ

### Effectså¤„ç†å™¨æ¶æ„

Effectsç³»ç»Ÿæ˜¯æ¸¸æˆæˆ˜æ–—æœºåˆ¶çš„æ ¸å¿ƒï¼ŒPlayerç±»ä¸Effectsç³»ç»Ÿæ·±åº¦é›†æˆï¼š

```javascript
// å›åˆå¼€å§‹æ—¶çš„æ•ˆæœå¤„ç†
export function processStartOfTurnEffects(target) {
  // æ‘§æ¯æŠ¤ç›¾
  if(target.effects['è­¦æˆ’'] > 0) {
    target.addEffect('è­¦æˆ’', -1);
  } else {
    target.shield = 0;
  }

  // å¤„ç†ç‡ƒçƒ§æ•ˆæœ
  if (target.effects['ç‡ƒçƒ§'] > 0) {
    let damage = target.effects['ç‡ƒçƒ§'];
    damage -= target.effects['ç«ç„°æŠ—æ€§'] || 0;
    target.addEffect('ç‡ƒçƒ§', -1);
    if(damage > 0) {
      dealDamage(null, target, damage);
    }
  }
  
  // èšæ°”æ•ˆæœ
  if (target.effects['èšæ°”'] > 0) {
    if (typeof target.gainMana === 'function') {
      target.gainMana(target.effects['èšæ°”']);
    }
    target.addEffect('èšæ°”', -target.effects['èšæ°”']);
  }

  // æœ€åå†å¤„ç†çœ©æ™•æ•ˆæœ
  if (target.effects['çœ©æ™•'] > 0) {
    target.addEffect('çœ©æ™•', -1);
    return true; // è¿”å›trueè¡¨ç¤ºéœ€è¦è·³è¿‡å›åˆ
  }

  return false;
}
```

### å±æ€§ä¸Effectsçš„äº¤äº’

ç³»ç»Ÿå®ç°äº†å±æ€§ä¸Effectsçš„æ— ç¼äº¤äº’ï¼š

```javascript
// æ”»å‡»åŠ›è®¡ç®—ä¸­çš„Effectså½±å“
get attack() {
  return this.baseAttack + (this.effects['åŠ›é‡'] || 0);
}

// é˜²å¾¡åŠ›è®¡ç®—ä¸­çš„Effectså½±å“
get defense() {
  return this.baseDefense + (this.effects['åšå›º'] || 0);
}

// çµèƒ½å¼ºåº¦è®¡ç®—ä¸­çš„Effectså½±å“
get magic() {
  return this.baseMagic + (this.effects['é›†ä¸­'] || 0);
}
```

### æˆ˜æ–—ä¸­çš„Effectsåº”ç”¨

åœ¨æˆ˜æ–—è¿‡ç¨‹ä¸­ï¼ŒEffectsç³»ç»Ÿä¼šæŒç»­å½±å“ç©å®¶å±æ€§ï¼š

```javascript
// æ”»å‡»ç»“ç®—æ—¶çš„Effectså¤„ç†
export function launchAttack(attacker, target, damage) {
  // æ”»å‡»è€…å¯¹æ”»å‡»çš„åå¤„ç†
  let finalDamage = damage + attacker.attack;
  if (attacker) {
    finalDamage = processPostAttackEffects(attacker, target, damage);
  }
  
  // å¤„ç†å—åˆ°æ”»å‡»æ—¶çš„æ•ˆæœ
  finalDamage = processAttackTakenEffects(target, finalDamage);
  
  // å›ºå®šé˜²å¾¡å‡å…
  finalDamage = Math.max(finalDamage - target.defense, 0);

  const result = applyDamageAndLog(target, finalDamage, { mode: 'attack', attacker });
  
  if (!result.dead) {
    // å‘å°„æ”»å‡»å®Œæˆäº‹ä»¶ï¼Œç”¨äºç»“ç®—æ”»å‡»ç‰¹æ•ˆç­‰
    processAttackFinishEffects(attacker, target, result.hpDamage, result.passThoughDamage);
  }
  
  return result;
}
```

**ç« èŠ‚æ¥æº**
- [src/data/effectProcessor.js](file://src/data/effectProcessor.js#L15-L100)
- [src/data/battleUtils.js](file://src/data/battleUtils.js#L80-L120)

## æ€§èƒ½è€ƒè™‘

### ä¼˜åŒ–ç­–ç•¥

1. **Proxyç¼“å­˜æœºåˆ¶**ï¼šç³»ç»Ÿä½¿ç”¨Proxyå¯¹è±¡è¿›è¡Œå±æ€§ä¿®æ­£ï¼Œé¿å…é‡å¤è®¡ç®—
2. **æ¡ä»¶æ¸²æŸ“**ï¼šUIç»„ä»¶æ ¹æ®çŠ¶æ€æ¡ä»¶æ¸²æŸ“ä¸åŒçš„å…ƒç´ 
3. **äº‹ä»¶èŠ‚æµ**ï¼šä½¿ç”¨äº‹ä»¶æ€»çº¿å‡å°‘é¢‘ç¹çš„çŠ¶æ€æ›´æ–°
4. **åŠ¨ç”»ä¼˜åŒ–**ï¼šåˆ©ç”¨CSSå˜æ¢å’ŒGPUåŠ é€Ÿæå‡åŠ¨ç”»æ€§èƒ½

### å†…å­˜ç®¡ç†

```javascript
// æ¸…ç†Effectsç³»ç»Ÿ
function battleVictory(isVictory) {
  gameState.player.effects = {};
  gameState.player.shield = 0;
  
  // æ¸…ç†æ‰€æœ‰å’å”±æŠ€èƒ½
  if (Array.isArray(gameState.player.activatedSkills) && gameState.player.activatedSkills.length) {
    for (const s of [...gameState.player.activatedSkills]) {
      try { s.onDisable(gameState.player, 'battleEnd'); } catch (_) {}
    }
    gameState.player.activatedSkills = [];
  }
}
```

### å“åº”å¼æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨`deep: true`ç›‘å¬å¤æ‚å¯¹è±¡å˜åŒ–
- å®ç°æ™ºèƒ½çš„å˜æ›´æ£€æµ‹æœºåˆ¶
- é¿å…ä¸å¿…è¦çš„DOMæ›´æ–°

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

#### å±æ€§å€¼å¼‚å¸¸

**é—®é¢˜**ï¼šç©å®¶å±æ€§å€¼è¶…å‡ºé¢„æœŸèŒƒå›´
**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// æ·»åŠ è¾¹ç•Œæ£€æŸ¥
consumeMana(amount) {
  if (isNaN(amount) || amount < 0) {
    console.error('æ— æ•ˆçš„æ³•åŠ›å€¼æ¶ˆè€—ï¼š', amount);
    return;
  }
  this.mana = Math.max(Math.min(this.mana - amount, this.maxMana), 0);
}
```

#### UIåŒæ­¥é—®é¢˜

**é—®é¢˜**ï¼šUIæ˜¾ç¤ºä¸å®é™…å±æ€§å€¼ä¸ä¸€è‡´
**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// å¼ºåˆ¶åˆ·æ–°UI
watch: {
  player: {
    handler() {
      this.$forceUpdate(); // å¼ºåˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“
    },
    deep: true
  }
}
```

#### Effectså¤„ç†å¼‚å¸¸

**é—®é¢˜**ï¼šEffectså¯¼è‡´å±æ€§è®¡ç®—é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// æ·»åŠ EffectséªŒè¯
addEffect(effectName, stacks = 1) {
  if (!effectName || typeof stacks !== 'number') {
    console.warn('æ— æ•ˆçš„Effectså‚æ•°ï¼š', effectName, stacks);
    return;
  }
  // æ­£å¸¸å¤„ç†é€»è¾‘...
}
```

### è°ƒè¯•å·¥å…·

ç³»ç»Ÿæä¾›äº†å®Œå–„çš„è°ƒè¯•æ”¯æŒï¼š

```javascript
// å±æ€§çŠ¶æ€ç›‘æ§
console.log('ç©å®¶å±æ€§çŠ¶æ€ï¼š', {
  hp: this.hp,
  maxHp: this.maxHp,
  shield: this.shield,
  mana: this.mana,
  maxMana: this.maxMana,
  actionPoints: this.remainingActionPoints,
  effects: this.effects
});
```

**ç« èŠ‚æ¥æº**
- [src/data/player.js](file://src/data/player.js#L200-L226)
- [src/data/battle.js](file://src/data/battle.js#L450-L500)

## ç»“è®º

ç©å®¶å±æ€§ç³»ç»Ÿæ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯ã€åŠŸèƒ½å®Œå¤‡çš„æ¸¸æˆæ ¸å¿ƒç»„ä»¶ã€‚å®ƒé€šè¿‡ä»¥ä¸‹ç‰¹ç‚¹ç¡®ä¿äº†ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒå’Œå¼€å‘ä½“éªŒï¼š

### ä¸»è¦ä¼˜åŠ¿

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
2. **å“åº”å¼æ¶æ„**ï¼šåŸºäºVue.jsçš„å®æ—¶æ•°æ®ç»‘å®šæœºåˆ¶
3. **çµæ´»çš„æ‰©å±•æ€§**ï¼šæ”¯æŒå±æ€§ä¿®æ­£å™¨å’ŒEffectsç³»ç»Ÿ
4. **å®Œå–„çš„è¾¹ç•Œä¿æŠ¤**ï¼šé˜²æ­¢å±æ€§å€¼è¶Šç•Œå’Œå¼‚å¸¸æƒ…å†µ
5. **ä¸°å¯Œçš„è§†è§‰åé¦ˆ**ï¼šåŠ¨ç”»å’Œç²’å­æ•ˆæœæå‡æ¸¸æˆä½“éªŒ

### æŠ€æœ¯äº®ç‚¹

- **é¢å‘å¯¹è±¡è®¾è®¡**ï¼šUnitåŸºç±»æä¾›ç»Ÿä¸€çš„å±æ€§æ¥å£
- **Proxyä»£ç†æœºåˆ¶**ï¼šå®ç°é«˜æ•ˆçš„å±æ€§ä¿®æ­£ç³»ç»Ÿ
- **Effectsæ·±åº¦é›†æˆ**ï¼šå®Œæ•´çš„æˆ˜æ–—æ•ˆæœå¤„ç†é“¾è·¯
- **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼šå¤šå±‚æ¬¡çš„æ€§èƒ½ä¼˜åŒ–æªæ–½
- **é”™è¯¯å¤„ç†æœºåˆ¶**ï¼šå…¨é¢çš„å¼‚å¸¸å¤„ç†å’Œæ¢å¤ç­–ç•¥

### æœªæ¥å‘å±•æ–¹å‘

1. **æ€§èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–**ï¼šè€ƒè™‘ä½¿ç”¨Web Workerså¤„ç†å¤æ‚è®¡ç®—
2. **æ‰©å±•Effectsç³»ç»Ÿ**ï¼šæ”¯æŒæ›´å¤æ‚çš„å±æ€§äº¤äº’é€»è¾‘
3. **å¢å¼ºè°ƒè¯•åŠŸèƒ½**ï¼šæä¾›æ›´è¯¦ç»†çš„å±æ€§å˜åŒ–è¿½è¸ª
4. **ç§»åŠ¨ç«¯é€‚é…**ï¼šä¼˜åŒ–è§¦æ‘¸äº¤äº’å’Œå“åº”å¼å¸ƒå±€
5. **å¯è®¿é—®æ€§æ”¹è¿›**ï¼šå¢åŠ å±å¹•é˜…è¯»å™¨æ”¯æŒå’Œé”®ç›˜å¯¼èˆª

è¯¥ç³»ç»Ÿä¸ºæ¸¸æˆã€ŠWeKyspireã€‹æä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ï¼Œç¡®ä¿äº†æˆ˜æ–—ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç©æ€§ï¼ŒåŒæ—¶ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•é¢„ç•™äº†å……è¶³çš„ç©ºé—´ã€‚