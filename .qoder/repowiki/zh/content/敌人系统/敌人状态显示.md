# æ•ŒäººçŠ¶æ€æ˜¾ç¤ºç»„ä»¶è¯¦ç»†åˆ†æ

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [EnemyStatusPanel.vue](file://src/components/battle/EnemyStatusPanel.vue)
- [HealthBar.vue](file://src/components/global/HealthBar.vue)
- [EffectDisplayBar.vue](file://src/components/global/EffectDisplayBar.vue)
- [HurtAnimationWrapper.vue](file://src/components/global/HurtAnimationWrapper.vue)
- [enemy.js](file://src/data/enemy.js)
- [unit.js](file://src/data/unit.js)
- [player.js](file://src/data/player.js)
- [gameState.js](file://src/data/gameState.js)
- [battle.js](file://src/data/battle.js)
- [effectDescription.js](file://src/data/effectDescription.js)
- [frontendEventBus.js](file://src/frontendEventBus.js)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„æ¦‚è§ˆ](#é¡¹ç›®ç»“æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒç»„ä»¶æ¶æ„](#æ ¸å¿ƒç»„ä»¶æ¶æ„)
4. [EnemyStatusPanelç»„ä»¶è¯¦ç»†åˆ†æ](#enemystatuspanelç»„ä»¶è¯¦ç»†åˆ†æ)
5. [æ•°æ®æ¨¡å‹ä¸çŠ¶æ€ç®¡ç†](#æ•°æ®æ¨¡å‹ä¸çŠ¶æ€ç®¡ç†)
6. [åŠ¨ç”»ä¸è§†è§‰åé¦ˆç³»ç»Ÿ](#åŠ¨ç”»ä¸è§†è§‰åé¦ˆç³»ç»Ÿ)
7. [çŠ¶æ€æ•ˆæœæ˜¾ç¤ºæœºåˆ¶](#çŠ¶æ€æ•ˆæœæ˜¾ç¤ºæœºåˆ¶)
8. [ç»„ä»¶é—´é€šä¿¡ä¸äº‹ä»¶å¤„ç†](#ç»„ä»¶é—´é€šä¿¡ä¸äº‹ä»¶å¤„ç†)
9. [æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ](#æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ)
10. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
11. [æ€»ç»“](#æ€»ç»“)

## ç®€ä»‹

EnemyStatusPanel.vueæ˜¯æˆ˜æ–—ç•Œé¢ä¸­è´Ÿè´£å±•ç¤ºæ•ŒäººçŠ¶æ€ä¿¡æ¯çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒæä¾›äº†å®Œæ•´çš„æ•Œäººç”Ÿå‘½å€¼ã€æŠ¤ç›¾ã€çŠ¶æ€æ•ˆæœç­‰ä¿¡æ¯çš„å¯è§†åŒ–å±•ç¤ºã€‚è¯¥ç»„ä»¶é€šè¿‡å“åº”å¼æ•°æ®ç»‘å®šä¸gameStateä¸­çš„æ•Œäººæ•°æ®ä¿æŒå®æ—¶åŒæ­¥ï¼ŒåŒæ—¶é›†æˆäº†ä¸°å¯Œçš„åŠ¨ç”»æ•ˆæœå’Œç”¨æˆ·äº¤äº’åŠŸèƒ½ã€‚

## é¡¹ç›®ç»“æ„æ¦‚è§ˆ

```mermaid
graph TB
subgraph "æˆ˜æ–—ç•Œé¢ç»„ä»¶"
EnemyStatusPanel["EnemyStatusPanel.vue<br/>æ•ŒäººçŠ¶æ€é¢æ¿"]
BattleScreen["BattleScreen.vue<br/>æˆ˜æ–—å±å¹•"]
PlayerStatusPanel["PlayerStatusPanel.vue<br/>ç©å®¶çŠ¶æ€é¢æ¿"]
end
subgraph "å…¨å±€ç»„ä»¶"
HealthBar["HealthBar.vue<br/>ç”Ÿå‘½æ¡ç»„ä»¶"]
EffectDisplayBar["EffectDisplayBar.vue<br/>æ•ˆæœæ˜¾ç¤ºæ "]
HurtAnimationWrapper["HurtAnimationWrapper.vue<br/>å—ä¼¤åŠ¨ç”»åŒ…è£…å™¨"]
end
subgraph "æ•°æ®å±‚"
GameState["gameState.js<br/>æ¸¸æˆçŠ¶æ€ç®¡ç†"]
Enemy["enemy.js<br/>æ•Œäººæ•°æ®æ¨¡å‹"]
Unit["unit.js<br/>åŸºç¡€å•ä½æ¨¡å‹"]
Battle["battle.js<br/>æˆ˜æ–—é€»è¾‘"]
end
subgraph "äº‹ä»¶ç³»ç»Ÿ"
FrontendEventBus["frontendEventBus.js<br/>å‰ç«¯äº‹ä»¶æ€»çº¿"]
end
BattleScreen --> EnemyStatusPanel
BattleScreen --> PlayerStatusPanel
EnemyStatusPanel --> HealthBar
EnemyStatusPanel --> EffectDisplayBar
EnemyStatusPanel --> HurtAnimationWrapper
EnemyStatusPanel --> GameState
HealthBar --> GameState
EffectDisplayBar --> GameState
HurtAnimationWrapper --> FrontendEventBus
Enemy --> Unit
GameState --> Enemy
Battle --> GameState
```

**å›¾è¡¨æ¥æº**
- [EnemyStatusPanel.vue](file://src/components/battle/EnemyStatusPanel.vue#L1-L326)
- [BattleScreen.vue](file://src/components/battle/BattleScreen.vue#L1-L110)
- [gameState.js](file://src/data/gameState.js#L1-L75)

## æ ¸å¿ƒç»„ä»¶æ¶æ„

EnemyStatusPanelç»„ä»¶é‡‡ç”¨äº†æ¨¡å—åŒ–çš„è®¾è®¡æ¶æ„ï¼Œå°†ä¸åŒçš„åŠŸèƒ½èŒè´£åˆ†é…ç»™ä¸“é—¨çš„å­ç»„ä»¶ï¼š

```mermaid
classDiagram
class EnemyStatusPanel {
+Object enemy
+Object enemyInfo
+showEnemyInfo(event)
+hideEnemyInfo()
+mounted()
+beforeUnmount()
}
class HurtAnimationWrapper {
+Object unit
+Number zIndex
+Boolean isShaking
+Boolean isHurt
+Boolean isEvading
+Boolean isHealing
+Boolean isDead
+onUnitHurt(payload)
+onUnitDeath(payload)
+createDamageText(damage)
+createParticles(damageMagnitude)
}
class HealthBar {
+Object unit
+Boolean shieldChanged
+playShieldChangeAnimation()
}
class EffectDisplayBar {
+Object effects
+Object target
+Object previousEffects
+showTooltip(event, effectName)
+hideTooltip()
+handleEffectsChanged(curr, prev)
+playEffectExpiredAnimation(effectName)
}
EnemyStatusPanel --> HurtAnimationWrapper : "åŒ…å«"
EnemyStatusPanel --> HealthBar : "åŒ…å«"
EnemyStatusPanel --> EffectDisplayBar : "åŒ…å«"
HurtAnimationWrapper --> FrontendEventBus : "ç›‘å¬äº‹ä»¶"
HealthBar --> Unit : "ä½¿ç”¨æ•°æ®"
EffectDisplayBar --> Unit : "ä½¿ç”¨æ•°æ®"
```

**å›¾è¡¨æ¥æº**
- [EnemyStatusPanel.vue](file://src/components/battle/EnemyStatusPanel.vue#L45-L122)
- [HurtAnimationWrapper.vue](file://src/components/global/HurtAnimationWrapper.vue#L1-L362)
- [HealthBar.vue](file://src/components/global/HealthBar.vue#L1-L101)
- [EffectDisplayBar.vue](file://src/components/global/EffectDisplayBar.vue#L1-L154)

## EnemyStatusPanelç»„ä»¶è¯¦ç»†åˆ†æ

### ç»„ä»¶ç»“æ„ä¸æ¨¡æ¿

EnemyStatusPanelç»„ä»¶é‡‡ç”¨åˆ†å±‚å¸ƒå±€è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

1. **å¤´åƒåŒºåŸŸ**ï¼šæ˜¾ç¤ºæ•Œäººçš„å¤´åƒæˆ–å ä½ç¬¦
2. **åŸºæœ¬ä¿¡æ¯åŒºåŸŸ**ï¼šæ˜¾ç¤ºæ•Œäººåç§°ã€ç±»å‹å’Œç»Ÿè®¡ä¿¡æ¯
3. **çŠ¶æ€æ•ˆæœåŒºåŸŸ**ï¼šå±•ç¤ºå½“å‰ç”Ÿæ•ˆçš„çŠ¶æ€æ•ˆæœ
4. **ç”Ÿå‘½æ¡åŒºåŸŸ**ï¼šæ˜¾ç¤ºç”Ÿå‘½å€¼å’ŒæŠ¤ç›¾çŠ¶æ€
5. **ä¿¡æ¯æ‚¬æµ®æ¡†**ï¼šæä¾›è¯¦ç»†çš„æ•Œäººä¿¡æ¯

```javascript
// ç»„ä»¶æ ¸å¿ƒå±æ€§å®šä¹‰
props: {
  enemy: {
    type: Object,
    required: true
  }
}
```

### å¤´åƒä¸åŸºæœ¬ä¿¡æ¯å±•ç¤º

ç»„ä»¶æ”¯æŒä¸¤ç§å¤´åƒæ˜¾ç¤ºæ–¹å¼ï¼š
- **å›¾ç‰‡å¤´åƒ**ï¼šå½“`enemy.avatarUrl`å­˜åœ¨æ—¶æ˜¾ç¤º
- **å ä½ç¬¦**ï¼šå½“æ²¡æœ‰å¤´åƒURLæ—¶æ˜¾ç¤ºé»‘è‰²èƒŒæ™¯

```javascript
// å¤´åƒæ¸²æŸ“é€»è¾‘
<div class="enemy-avatar">
  <img v-if="enemy.avatarUrl" :src="enemy.avatarUrl" :alt="enemy.name" class="avatar-image" />
  <div v-else class="avatar-placeholder"></div>
</div>
```

### ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º

ç»„ä»¶åŠ¨æ€æ˜¾ç¤ºæ•Œäººçš„æ”»å‡»å’Œé˜²å¾¡å±æ€§ï¼š

```javascript
<div class="enemy-stats">
  <div class="stat">
    <span class="stat-label">âš”ï¸ æ”»å‡»:</span>
    <span class="stat-value">{{ enemy.attack }}</span>
  </div>
  <div class="stat">
    <span class="stat-label">ğŸ›¡ï¸ é˜²å¾¡:</span>
    <span class="stat-value">{{ enemy.defense }}</span>
  </div>
</div>
```

### ä¿¡æ¯æ‚¬æµ®æ¡†åŠŸèƒ½

ç»„ä»¶å®ç°äº†é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯çš„åŠŸèƒ½ï¼š

```javascript
methods: {
  showEnemyInfo(event) {
    const wrapper = this.$el.closest('.hurt-animation-wrapper');
    if (wrapper) {
      const wrapperRect = wrapper.getBoundingClientRect();
      const buttonRect = event.target.getBoundingClientRect();
      
      const relativeX = buttonRect.left - wrapperRect.left + 30;
      const relativeY = buttonRect.top - wrapperRect.top - 10;
      
      this.enemyInfo = {
        show: true,
        x: relativeX,
        y: relativeY
      };
    }
  }
}
```

**ç« èŠ‚æ¥æº**
- [EnemyStatusPanel.vue](file://src/components/battle/EnemyStatusPanel.vue#L1-L326)

## æ•°æ®æ¨¡å‹ä¸çŠ¶æ€ç®¡ç†

### UnitåŸºç±»è®¾è®¡

EnemyStatusPanelç»„ä»¶åŸºäºUnitåŸºç±»çš„æ•°æ®æ¨¡å‹ï¼Œè¯¥ç±»æä¾›äº†ç»Ÿä¸€çš„å±æ€§è®¡ç®—å’Œæ•ˆæœç®¡ç†ç³»ç»Ÿï¼š

```mermaid
classDiagram
class Unit {
+String type
+String name
+Number hp
+Number maxHp
+Number shield
+Number baseAttack
+Number baseDefense
+Number baseMagic
+Object effects
+get attack()
+get defense()
+get magic()
+addEffect(effectName, stacks)
+removeEffect(effectName, stacks)
+hasEffect(effectName)
+applyHeal(heal)
+removeEffects(count, mode, type)
+clearEffects(type)
}
class Enemy {
+String subtitle
+String description
+String type
+String avatarUrl
+String uniqueID
+Boolean isBoss
+Boolean isSpecial
+Boolean isNormal
+init()
+act(player)
}
class Player {
+Number mana
+Number maxMana
+Number remainingActionPoints
+Number maxActionPoints
+Number money
+Number tier
+Array cultivatedSkills
+Array frontierSkills
+Array backupSkills
+Array burntSkills
+Array activatedSkills
+Object leinoFactors
+Array abilities
+addLeino(type, value)
+getLeinoWeight(type)
+getAllLeinoWeight()
+canShiftSkill()
+addModifier(modifierFn)
+removeModifier(modifierFn)
+getModifiedPlayer()
+canDropFirstSkill()
+addBackupSkill(skill)
+consumeActionPoints(amount)
+consumeMana(amount)
+gainMana(amount)
+gainActionPoint(amount)
+hasAbility(abilityName)
+hasFreeActivatedSlot()
+getFirstActivatedSkill()
}
Unit <|-- Enemy : "ç»§æ‰¿"
Unit <|-- Player : "ç»§æ‰¿"
```

**å›¾è¡¨æ¥æº**
- [unit.js](file://src/data/unit.js#L1-L143)
- [enemy.js](file://src/data/enemy.js#L1-L44)
- [player.js](file://src/data/player.js#L1-L226)

### æ•ˆæœç³»ç»Ÿé›†æˆ

EnemyStatusPanelç»„ä»¶é€šè¿‡EffectDisplayBarç»„ä»¶å±•ç¤ºæ•Œäººçš„çŠ¶æ€æ•ˆæœï¼š

```javascript
// æ•ˆæœæ˜¾ç¤ºæ é…ç½®
<EffectDisplayBar 
  :effects="enemy.effects"
  :target="enemy"
  @show-tooltip="$emit('show-tooltip', $event)"
  @hide-tooltip="$emit('hide-tooltip')"
/>
```

æ•ˆæœç³»ç»Ÿæ”¯æŒå¤šç§ç±»å‹çš„æ•ˆæœï¼š
- **å¢ç›Šæ•ˆæœ**ï¼ˆBuffï¼‰ï¼šåŠ›é‡ã€åšå›ºã€é›†ä¸­ç­‰
- **å‡ç›Šæ•ˆæœ**ï¼ˆDebuffï¼‰ï¼šæ˜“ä¼¤ã€è™šå¼±ã€ä¸­æ¯’ç­‰
- **ä¸­æ€§æ•ˆæœ**ï¼šå†ç”Ÿã€èšæ°”ã€ç‡ƒçƒ§ç­‰

### ç”Ÿå‘½å€¼ä¸æŠ¤ç›¾æ˜¾ç¤º

é€šè¿‡HealthBarç»„ä»¶å®ç°ç”Ÿå‘½å€¼å’ŒæŠ¤ç›¾çš„å¯è§†åŒ–ï¼š

```javascript
// ç”Ÿå‘½æ¡é…ç½®
<HealthBar :unit="enemy" class="enemy" />
```

HealthBarç»„ä»¶æä¾›äº†ä»¥ä¸‹ç‰¹æ€§ï¼š
- **ç”Ÿå‘½å€¼è¿›åº¦æ¡**ï¼šæ˜¾ç¤ºå½“å‰ç”Ÿå‘½å€¼ä¸æœ€å¤§ç”Ÿå‘½å€¼çš„æ¯”ä¾‹
- **æŠ¤ç›¾æ˜¾ç¤º**ï¼šå½“å­˜åœ¨æŠ¤ç›¾æ—¶æ˜¾ç¤ºæŠ¤ç›¾æ•°å€¼
- **ç¼©æ”¾åŠ¨ç”»**ï¼šæŠ¤ç›¾å˜åŒ–æ—¶æ’­æ”¾ç¼©æ”¾åŠ¨ç”»æ•ˆæœ

**ç« èŠ‚æ¥æº**
- [unit.js](file://src/data/unit.js#L1-L143)
- [enemy.js](file://src/data/enemy.js#L1-L44)
- [HealthBar.vue](file://src/components/global/HealthBar.vue#L1-L101)
- [EffectDisplayBar.vue](file://src/components/global/EffectDisplayBar.vue#L1-L154)

## åŠ¨ç”»ä¸è§†è§‰åé¦ˆç³»ç»Ÿ

### HurtAnimationWrapperåŠ¨ç”»ç³»ç»Ÿ

HurtAnimationWrapperæ˜¯EnemyStatusPanelçš„æ ¸å¿ƒåŠ¨ç”»ç»„ä»¶ï¼Œæä¾›äº†å®Œæ•´çš„å—ä¼¤åé¦ˆç³»ç»Ÿï¼š

```mermaid
sequenceDiagram
participant EventBus as "å‰ç«¯äº‹ä»¶æ€»çº¿"
participant Wrapper as "HurtAnimationWrapper"
participant Particles as "ç²’å­ç³»ç»Ÿ"
participant UI as "ç”¨æˆ·ç•Œé¢"
EventBus->>Wrapper : unit-hurt
Wrapper->>Wrapper : onUnitHurt(payload)
Wrapper->>Wrapper : æ£€æŸ¥ä¼¤å®³ç±»å‹
alt HPä¼¤å®³
Wrapper->>UI : æ˜¾ç¤ºå—ä¼¤åŠ¨ç”»
Wrapper->>Particles : åˆ›å»ºä¼¤å®³ç²’å­
Wrapper->>UI : æ˜¾ç¤ºä¼¤å®³æ–‡æœ¬
else Shieldä¼¤å®³
Wrapper->>UI : æ˜¾ç¤ºæŠ¤ç›¾ç ´ç¢åŠ¨ç”»
Wrapper->>Particles : åˆ›å»ºæŠ¤ç›¾ç²’å­
Wrapper->>UI : æ˜¾ç¤ºæŠ¤ç›¾æ–‡æœ¬
else Healing
Wrapper->>UI : æ˜¾ç¤ºæ²»ç–—åŠ¨ç”»
Wrapper->>Particles : åˆ›å»ºæ²»ç–—ç²’å­
Wrapper->>UI : æ˜¾ç¤ºæ²»ç–—æ–‡æœ¬
else Evade
Wrapper->>UI : æ˜¾ç¤ºé—ªé¿åŠ¨ç”»
end
EventBus->>Wrapper : unit-death
Wrapper->>Wrapper : onUnitDeath(payload)
Wrapper->>Particles : åˆ›å»ºæ­»äº¡çˆ†ç‚¸ç²’å­
Wrapper->>UI : æ˜¾ç¤ºæ­»äº¡æ•ˆæœ
```

**å›¾è¡¨æ¥æº**
- [HurtAnimationWrapper.vue](file://src/components/global/HurtAnimationWrapper.vue#L80-L180)
- [frontendEventBus.js](file://src/frontendEventBus.js#L1-L9)

### åŠ¨ç”»æ•ˆæœç±»å‹

HurtAnimationWrapperæ”¯æŒå¤šç§åŠ¨ç”»æ•ˆæœï¼š

1. **å—ä¼¤åŠ¨ç”»ï¼ˆHurt Animationï¼‰**
   - è¾¹æ¡†é—ªçƒæ•ˆæœ
   - ä¼¤å®³æ•°å€¼æµ®åŠ¨åŠ¨ç”»
   - ç²’å­çˆ†ç‚¸æ•ˆæœ

2. **é—ªé¿åŠ¨ç”»ï¼ˆEvade Animationï¼‰**
   - æ—‹è½¬æ‘†åŠ¨æ•ˆæœ
   - å¿«é€Ÿæ·¡å‡º

3. **æ²»ç–—åŠ¨ç”»ï¼ˆHeal Animationï¼‰**
   - ç»¿è‰²è¦†ç›–å±‚
   - æ²»ç–—æ•°å€¼æµ®åŠ¨

4. **æ­»äº¡åŠ¨ç”»ï¼ˆDeath Animationï¼‰**
   - ç™½è‰²é—ªå…‰æ•ˆæœ
   - çˆ†ç‚¸ç²’å­ç³»ç»Ÿ
   - é€æ¸æ¶ˆå¤±æ•ˆæœ

### ç²’å­ç³»ç»Ÿé›†æˆ

ç»„ä»¶é€šè¿‡frontendEventBusä¸ç²’å­ç³»ç»Ÿé€šä¿¡ï¼š

```javascript
// åˆ›å»ºä¼¤å®³æ–‡æœ¬ç²’å­
createDamageText(damage, isShieldDamage = false) {
  const text = damage < 0 ? `+${Math.abs(damage)}` : `-${damage}`;
  const color = damage < 0 ? '#00ff00' : (isShieldDamage ? '#666666' : '#ff0000');
  
  const particle = {
    x: startX,
    y: startY,
    vx: velocityX,
    vy: velocityY,
    gravity: gravity,
    life: duration,
    size: fontSize,
    text: text,
    extraStyles: {
      color: color,
      fontSize: `${fontSize}px`,
      fontWeight: 'bold'
    }
  };
  
  frontendEventBus.emit('spawn-particles', [particle]);
}
```

**ç« èŠ‚æ¥æº**
- [HurtAnimationWrapper.vue](file://src/components/global/HurtAnimationWrapper.vue#L1-L362)

## çŠ¶æ€æ•ˆæœæ˜¾ç¤ºæœºåˆ¶

### EffectDisplayBarç»„ä»¶æ¶æ„

EffectDisplayBarç»„ä»¶è´Ÿè´£å±•ç¤ºæ•Œäººçš„çŠ¶æ€æ•ˆæœï¼Œé‡‡ç”¨å›¾æ ‡åŠ å †å å±‚æ•°çš„æ–¹å¼æ˜¾ç¤ºï¼š

```javascript
// æ•ˆæœå›¾æ ‡æ¸²æŸ“
<div v-for="(value, key) in effects" :key="key">
  <EffectIcon
    v-if="value !== 0" 
    :effect-name="key"
    :stack="value"
    :preview-mode="false"
    @mouseenter="showTooltip($event, key)"
    @mouseleave="hideTooltip()"
  />
</div>
```

### æ•ˆæœæè¿°ç³»ç»Ÿ

ç³»ç»Ÿç»´æŠ¤äº†ä¸€ä¸ªå®Œæ•´çš„æ•ˆæœæè¿°æ•°æ®åº“ï¼ŒåŒ…å«æ¯ä¸ªæ•ˆæœçš„è¯¦ç»†ä¿¡æ¯ï¼š

```javascript
// æ•ˆæœæè¿°ç¤ºä¾‹
const effectDescriptions = {
  'åŠ›é‡': {
    name: 'åŠ›é‡',
    description: 'é€ æˆä¼¤å®³æ—¶ï¼Œæå‡å±‚æ•°ç‚¹ä¼¤å®³',
    type: 'buff',
    icon: 'âš”ï¸',
    color: '#FF4500'
  },
  'æ˜“ä¼¤': {
    name: 'æ˜“ä¼¤',
    description: 'å—åˆ°150%ä¼¤å®³ï¼Œå›åˆç»“æŸæ—¶ï¼Œå±‚æ•°å‡1',
    type: 'debuff',
    icon: 'ğŸ’¥',
    color: '#FF4500'
  }
};
```

### æ•ˆæœè¿‡æœŸåŠ¨ç”»

å½“æ•ˆæœå±‚æ•°å½’é›¶æ—¶ï¼Œç³»ç»Ÿä¼šè§¦å‘ç‰¹æ®Šçš„è¿‡æœŸåŠ¨ç”»ï¼š

```javascript
// æ•ˆæœè¿‡æœŸåŠ¨ç”»å¤„ç†
handleEffectsChanged(curr, prev) {
  const prevKeys = Object.keys(prev || {});
  for (const effectName of prevKeys) {
    const previousStacks = prev[effectName] || 0;
    const currStacks = (curr && curr[effectName]) || 0;
    if (previousStacks > 0 && currStacks === 0) {
      this.playEffectExpiredAnimation(effectName);
    }
  }
}
```

### äº¤äº’åé¦ˆ

ç»„ä»¶æä¾›äº†å®Œæ•´çš„é¼ æ ‡äº¤äº’åé¦ˆï¼š
- **é¼ æ ‡æ‚¬åœ**ï¼šæ˜¾ç¤ºæ•ˆæœè¯¦ç»†æè¿°
- **é¼ æ ‡ç¦»å¼€**ï¼šéšè—æç¤ºä¿¡æ¯
- **åŠ¨ç”»æ•ˆæœ**ï¼šæ•ˆæœå›¾æ ‡æ”¾å¤§åŠ¨ç”»

**ç« èŠ‚æ¥æº**
- [EffectDisplayBar.vue](file://src/components/global/EffectDisplayBar.vue#L1-L154)
- [effectDescription.js](file://src/data/effectDescription.js#L1-L301)

## ç»„ä»¶é—´é€šä¿¡ä¸äº‹ä»¶å¤„ç†

### å‰ç«¯äº‹ä»¶æ€»çº¿

ç³»ç»Ÿä½¿ç”¨mittåº“å®ç°è½»é‡çº§çš„äº‹ä»¶æ€»çº¿é€šä¿¡ï¼š

```javascript
// äº‹ä»¶æ€»çº¿åˆå§‹åŒ–
import mitt from 'mitt';
const frontendEventBus = mitt();
export default frontendEventBus;
```

### ä¸»è¦äº‹ä»¶ç±»å‹

EnemyStatusPanelç»„ä»¶ç›‘å¬ä»¥ä¸‹äº‹ä»¶ï¼š

1. **unit-hurtäº‹ä»¶**
   - å‚æ•°ï¼š`{ unitId, hpDamage, passThroughDamage }`
   - è§¦å‘æ—¶æœºï¼šæ•Œäººå—åˆ°ä¼¤å®³æ—¶
   - å¤„ç†å†…å®¹ï¼šè§¦å‘å—ä¼¤åŠ¨ç”»å’Œè§†è§‰åé¦ˆ

2. **unit-deathäº‹ä»¶**
   - å‚æ•°ï¼š`{ unitId }`
   - è§¦å‘æ—¶æœºï¼šæ•Œäººç”Ÿå‘½å€¼é™è‡³0æ—¶
   - å¤„ç†å†…å®¹ï¼šè§¦å‘æ­»äº¡åŠ¨ç”»å’Œçˆ†ç‚¸æ•ˆæœ

### äº‹ä»¶ä¼ æ’­æµç¨‹

```mermaid
flowchart TD
Start([æˆ˜æ–—äº‹ä»¶è§¦å‘]) --> CheckUnit{"æ£€æŸ¥å•ä½ç±»å‹"}
CheckUnit --> |æ•Œäºº| EmitHurt["å‘å°„unit-hurtäº‹ä»¶"]
CheckUnit --> |ç©å®¶| EmitPlayer["å‘å°„player-eventäº‹ä»¶"]
EmitHurt --> ListenWrapper["HurtAnimationWrapperç›‘å¬"]
ListenWrapper --> CheckDamageType{"æ£€æŸ¥ä¼¤å®³ç±»å‹"}
CheckDamageType --> |HPä¼¤å®³| PlayHurtAnim["æ’­æ”¾å—ä¼¤åŠ¨ç”»"]
CheckDamageType --> |Shieldä¼¤å®³| PlayShieldAnim["æ’­æ”¾æŠ¤ç›¾åŠ¨ç”»"]
CheckDamageType --> |Healing| PlayHealAnim["æ’­æ”¾æ²»ç–—åŠ¨ç”»"]
CheckDamageType --> |Evade| PlayEvadeAnim["æ’­æ”¾é—ªé¿åŠ¨ç”»"]
PlayHurtAnim --> CreateParticles["åˆ›å»ºä¼¤å®³ç²’å­"]
PlayShieldAnim --> CreateShieldParticles["åˆ›å»ºæŠ¤ç›¾ç²’å­"]
PlayHealAnim --> CreateHealParticles["åˆ›å»ºæ²»ç–—ç²’å­"]
PlayEvadeAnim --> CreateEvadeParticles["åˆ›å»ºé—ªé¿ç²’å­"]
CreateParticles --> UpdateUI["æ›´æ–°UIçŠ¶æ€"]
CreateShieldParticles --> UpdateUI
CreateHealParticles --> UpdateUI
CreateEvadeParticles --> UpdateUI
UpdateUI --> End([åŠ¨ç”»å®Œæˆ])
```

**å›¾è¡¨æ¥æº**
- [HurtAnimationWrapper.vue](file://src/components/global/HurtAnimationWrapper.vue#L80-L180)
- [frontendEventBus.js](file://src/frontendEventBus.js#L1-L9)

### äº‹ä»¶å¤„ç†æœ€ä½³å®è·µ

1. **äº‹ä»¶å‘½åè§„èŒƒ**
   - ä½¿ç”¨æ¸…æ™°çš„å‘½åç©ºé—´ï¼š`unit-hurt`, `unit-death`
   - é¿å…äº‹ä»¶åç§°å†²çª
   - ä¿æŒäº‹ä»¶å‚æ•°ç»“æ„ä¸€è‡´æ€§

2. **å†…å­˜ç®¡ç†**
   - åœ¨ç»„ä»¶å¸è½½æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
   - é¿å…å†…å­˜æ³„æ¼

3. **é”™è¯¯å¤„ç†**
   - å¯¹äº‹ä»¶å¤„ç†å‡½æ•°è¿›è¡Œé”™è¯¯æ•è·
   - æä¾›é™çº§å¤„ç†æœºåˆ¶

**ç« èŠ‚æ¥æº**
- [frontendEventBus.js](file://src/frontendEventBus.js#L1-L9)
- [HurtAnimationWrapper.vue](file://src/components/global/HurtAnimationWrapper.vue#L80-L180)

## æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

### å“åº”å¼æ•°æ®ä¼˜åŒ–

EnemyStatusPanelç»„ä»¶é‡‡ç”¨äº†é«˜æ•ˆçš„å“åº”å¼æ•°æ®ç»‘å®šç­–ç•¥ï¼š

1. **ç²¾ç¡®çš„watchç›‘å¬**
   ```javascript
   watch: {
     // åªç›‘å¬å¿…è¦çš„æ•°æ®å˜åŒ–
     'unit.shield'(newShield, oldShield) {
       if (newShield !== oldShield) {
         this.playShieldChangeAnimation();
       }
     }
   }
   ```

2. **è®¡ç®—å±æ€§ç¼“å­˜**
   ```javascript
   computed: {
     isShielded() {
       return (this.unit?.shield || 0) > 0;
     }
   }
   ```

### DOMä¼˜åŒ–ç­–ç•¥

1. **æ¡ä»¶æ¸²æŸ“**
   - ä½¿ç”¨v-if/v-showä¼˜åŒ–DOMå…ƒç´ çš„åˆ›å»ºå’Œé”€æ¯
   - é¿å…ä¸å¿…è¦çš„DOMèŠ‚ç‚¹

2. **äº‹ä»¶å§”æ‰˜**
   - åœ¨EffectDisplayBarä¸­ä½¿ç”¨äº‹ä»¶å§”æ‰˜å‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡
   - ä¼˜åŒ–å¤§é‡æ•ˆæœå›¾æ ‡çš„äº‹ä»¶å¤„ç†

3. **CSSåŠ¨ç”»ä¼˜åŒ–**
   - ä½¿ç”¨transformå’Œopacityå±æ€§è§¦å‘ç¡¬ä»¶åŠ é€Ÿ
   - é¿å…é¢‘ç¹çš„é‡æ’å’Œé‡ç»˜

### å†…å­˜ç®¡ç†

1. **å®šæ—¶å™¨æ¸…ç†**
   ```javascript
   _clearTimers() {
     if (this._timers && this._timers.length) {
       for (const id of this._timers) clearTimeout(id);
       this._timers = [];
     }
   }
   ```

2. **äº‹ä»¶ç›‘å¬å™¨æ¸…ç†**
   ```javascript
   mounted() {
     frontendEventBus.on('unit-hurt', this.onUnitHurt);
     frontendEventBus.on('unit-death', this.onUnitDeath);
   },
   beforeUnmount() {
     this._clearTimers();
     frontendEventBus.off('unit-hurt', this.onUnitHurt);
     frontendEventBus.off('unit-death', this.onUnitDeath);
   }
   ```

### æ€§èƒ½ç›‘æ§å»ºè®®

1. **Vue DevToolsä½¿ç”¨**
   - ç›‘æ§ç»„ä»¶æ¸²æŸ“æ€§èƒ½
   - åˆ†æå“åº”å¼æ•°æ®å˜åŒ–
   - æ£€æŸ¥å†…å­˜æ³„æ¼

2. **æµè§ˆå™¨å¼€å‘è€…å·¥å…·**
   - ä½¿ç”¨Performanceé¢æ¿åˆ†æåŠ¨ç”»æ€§èƒ½
   - æ£€æŸ¥GPUä½¿ç”¨æƒ…å†µ
   - ç›‘æ§JavaScriptæ‰§è¡Œæ—¶é—´

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

1. **åŠ¨ç”»ä¸æ˜¾ç¤º**
   - **ç—‡çŠ¶**ï¼šå—ä¼¤ã€æ­»äº¡ç­‰åŠ¨ç”»æ•ˆæœä¸å‡ºç°
   - **åŸå› **ï¼šfrontendEventBusæœªæ­£ç¡®åˆå§‹åŒ–æˆ–äº‹ä»¶æœªæ­£ç¡®è§¦å‘
   - **è§£å†³æ–¹æ¡ˆ**ï¼š
     ```javascript
     // æ£€æŸ¥äº‹ä»¶æ€»çº¿æ˜¯å¦æ­£å¸¸å·¥ä½œ
     console.log(frontendEventBus);
     
     // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ³¨å†Œ
     console.log('Event listeners:', frontendEventBus.all);
     ```

2. **æ•ˆæœå›¾æ ‡æ˜¾ç¤ºå¼‚å¸¸**
   - **ç—‡çŠ¶**ï¼šçŠ¶æ€æ•ˆæœå›¾æ ‡ä¸æ˜¾ç¤ºæˆ–æ˜¾ç¤ºé”™è¯¯
   - **åŸå› **ï¼šeffectDescriptionsé…ç½®é”™è¯¯æˆ–ç»„ä»¶æœªæ­£ç¡®æ›´æ–°
   - **è§£å†³æ–¹æ¡ˆ**ï¼š
     ```javascript
     // æ£€æŸ¥æ•ˆæœæè¿°é…ç½®
     console.log(effectDescriptions);
     
     // å¼ºåˆ¶åˆ·æ–°æ•ˆæœæ˜¾ç¤º
     this.$forceUpdate();
     ```

3. **ç”Ÿå‘½å€¼æ˜¾ç¤ºé”™è¯¯**
   - **ç—‡çŠ¶**ï¼šç”Ÿå‘½å€¼è¿›åº¦æ¡æ˜¾ç¤ºä¸æ­£ç¡®
   - **åŸå› **ï¼šunitæ•°æ®æ¨¡å‹ä¸­çš„hp/maxHpå±æ€§å¼‚å¸¸
   - **è§£å†³æ–¹æ¡ˆ**ï¼š
     ```javascript
     // æ£€æŸ¥å•ä½æ•°æ®å®Œæ•´æ€§
     console.log('Unit data:', this.enemy);
     console.log('HP:', this.enemy.hp, 'Max HP:', this.enemy.maxHp);
     ```

4. **æ€§èƒ½é—®é¢˜**
   - **ç—‡çŠ¶**ï¼šåŠ¨ç”»å¡é¡¿æˆ–ç•Œé¢å“åº”ç¼“æ…¢
   - **åŸå› **ï¼šè¿‡å¤šçš„DOMæ“ä½œæˆ–äº‹ä»¶ç›‘å¬å™¨
   - **è§£å†³æ–¹æ¡ˆ**ï¼š
     ```javascript
     // å‡å°‘ä¸å¿…è¦çš„DOMæ“ä½œ
     // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–åŠ¨ç”»
     // æ¸…ç†ä¸å†éœ€è¦çš„äº‹ä»¶ç›‘å¬å™¨
     ```

### è°ƒè¯•æŠ€å·§

1. **ä½¿ç”¨Vue DevTools**
   - æ£€æŸ¥ç»„ä»¶çŠ¶æ€å’Œprops
   - ç›‘æ§äº‹ä»¶è§¦å‘
   - åˆ†ææ€§èƒ½ç“¶é¢ˆ

2. **æ§åˆ¶å°è°ƒè¯•**
   ```javascript
   // åœ¨ç»„ä»¶æ–¹æ³•ä¸­æ·»åŠ è°ƒè¯•è¾“å‡º
   console.log('Enemy status update:', this.enemy);
   ```

3. **ç½‘ç»œè¯·æ±‚ç›‘æ§**
   - æ£€æŸ¥avatarUrlåŠ è½½çŠ¶æ€
   - ç›‘æ§å¤–éƒ¨èµ„æºåŠ è½½æ—¶é—´

**ç« èŠ‚æ¥æº**
- [HurtAnimationWrapper.vue](file://src/components/global/HurtAnimationWrapper.vue#L80-L180)
- [EnemyStatusPanel.vue](file://src/components/battle/EnemyStatusPanel.vue#L45-L122)

## æ€»ç»“

EnemyStatusPanel.vueç»„ä»¶æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€è®¾è®¡ç²¾è‰¯çš„æˆ˜æ–—ç•Œé¢ç»„ä»¶ï¼Œå®ƒæˆåŠŸåœ°å®ç°äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

### æ ¸å¿ƒä¼˜åŠ¿

1. **å®Œæ•´çš„çŠ¶æ€å±•ç¤º**
   - ç”Ÿå‘½å€¼å’ŒæŠ¤ç›¾çš„å¯è§†åŒ–æ˜¾ç¤º
   - å®æ—¶çš„çŠ¶æ€æ•ˆæœå±•ç¤º
   - è¯¦ç»†çš„æ•Œäººä¿¡æ¯é¢æ¿

2. **ä¸°å¯Œçš„åŠ¨ç”»åé¦ˆ**
   - å—ä¼¤ã€æ­»äº¡ã€é—ªé¿ç­‰å¤šç§åŠ¨ç”»æ•ˆæœ
   - ç²’å­ç³»ç»Ÿé›†æˆçš„è§†è§‰åé¦ˆ
   - å¹³æ»‘çš„è¿‡æ¸¡åŠ¨ç”»

3. **å“åº”å¼æ•°æ®ç»‘å®š**
   - ä¸gameStateçš„æ·±åº¦é›†æˆ
   - è‡ªåŠ¨åŒ–çš„çŠ¶æ€æ›´æ–°
   - å®æ—¶çš„è§†è§‰åé¦ˆ

4. **è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ**
   - ç›´è§‚çš„ä¿¡æ¯å±•ç¤º
   - äº¤äº’å¼çš„è¯¦ç»†ä¿¡æ¯æŸ¥çœ‹
   - é€‚é…ä¸åŒç±»å‹çš„æ•Œäººï¼ˆæ™®é€šã€ç‰¹æ®Šã€BOSSï¼‰

### è®¾è®¡äº®ç‚¹

- **æ¨¡å—åŒ–æ¶æ„**ï¼šå°†ä¸åŒåŠŸèƒ½åˆ†ç¦»åˆ°ä¸“é—¨çš„å­ç»„ä»¶ä¸­
- **äº‹ä»¶é©±åŠ¨è®¾è®¡**ï¼šé€šè¿‡frontendEventBuså®ç°æ¾è€¦åˆçš„ç»„ä»¶é€šä¿¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†çš„DOMæ“ä½œå’ŒåŠ¨ç”»ç­–ç•¥
- **æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„æ•ˆæœç±»å‹å’ŒåŠ¨ç”»æ•ˆæœ

### æ”¹è¿›å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šè€ƒè™‘ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨æŠ€æœ¯å¤„ç†å¤§é‡æ•ˆæœå›¾æ ‡
2. **å¯è®¿é—®æ€§**ï¼šå¢å¼ºå±å¹•é˜…è¯»å™¨æ”¯æŒå’Œé”®ç›˜å¯¼èˆª
3. **å›½é™…åŒ–**ï¼šæ”¯æŒå¤šè¯­è¨€æ•ˆæœæè¿°å’Œæ–‡æœ¬
4. **ä¸»é¢˜å®šåˆ¶**ï¼šæä¾›æ›´çµæ´»çš„æ ·å¼å®šåˆ¶é€‰é¡¹

EnemyStatusPanelç»„ä»¶å±•ç°äº†ç°ä»£å‰ç«¯å¼€å‘çš„æœ€ä½³å®è·µï¼Œé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¶æ„å’Œä¸°å¯Œçš„äº¤äº’æ•ˆæœï¼Œä¸ºç©å®¶æä¾›äº†ç›´è§‚ã€ç”ŸåŠ¨çš„æˆ˜æ–—ä½“éªŒã€‚å®ƒçš„è®¾è®¡ç†å¿µå’Œå®ç°æ–¹å¼å€¼å¾—åœ¨ç±»ä¼¼é¡¹ç›®ä¸­å€Ÿé‰´å’Œåº”ç”¨ã€‚