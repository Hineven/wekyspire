<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/THREEJS_REFACTOR_FAST_PATH.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/THREEJS_REFACTOR_FAST_PATH.md" />
              <option name="updatedContent" value="# 无回退 / 一次性极速重构方案 (Big-Bang Fast Path)&#10;&#10;&gt; 前提：一次性版本更新内完成迁移；允许重构期功能残缺；不保留 Pixi 与 DOM 卡牌/烘焙；目标是最快搭建 Three.js + Troika 的长期健康基础。&#10;&#10;## 总体思路&#10;一次性切断旧链路：删除 Pixi/DOM-烘焙/双轨动画，建立极简 Three 场景 + 轻量 ECS/数据层，直连动画、文本、粒子与特效。优先达成“可显示 + 可交互 + 可扩展”的骨架，样式与高级表现最后补。&#10;&#10;## 快速阶段 (压缩版)&#10;| 阶段 | 目标 | 时间盒 | 关键产物 | 立即删掉 |&#10;|------|------|--------|----------|----------|&#10;| F0  | 根场景+渲染循环+输入 | 0.5 天 | ThreeRoot + 主循环 | — |&#10;| F1  | ECS/数据结构+实体注册 | 1 天 | EntityStore + CardEntity | animator.js, BakeManager, domBake |&#10;| F2  | 卡牌几何+贴图+简材质 | 1 天 | Atlas 打包脚本/基础 Shader | Pixi 依赖, GamePixiOverlay.vue |&#10;| F3  | Troika 文本 (名/费) | 0.5 天 | TextFactory+字体子集 | DOM SkillCard 可见部分 |&#10;| F4  | 输入/拖拽 (Raycaster) | 0.5 天 | PointerController | DOM 拖拽逻辑 |&#10;| F5  | 动画/指令统一 | 1 天 | AnimationRuntime(tween池) | 旧 animate-element 事件处理（改路由） |&#10;| F6  | 粒子引擎(Instanced) | 1 天 | ParticleEngine+Emit API | DOM 粒子 / spawn-particles DOM handlers |&#10;| F7  | 基础特效 | 1 天 | Shader uniforms &amp; effect registry | Pixi filters / renderers/effects/* |&#10;| F8  | 后处理管线 | 0.5 天 | Composer+PassStack | GameBackgroundScreen.vue (Pixi) |&#10;| F9  | HUD 复位 | 0.5 天 | OverlayLayer 抽象 | 与卡牌相关 DOM |&#10;| F10 | 收束/回填 | 1-2 天 | 最小战斗循环 | 旧死代码 |&#10;&#10;总工期预估：8–9 天净开发（视复杂度浮动）。&#10;&#10;## 删除清单（Day 1 物理删除）&#10;- src/webgl/PixiAppManager.js&#10;- src/webgl/BakeManager.js&#10;- src/webgl/domBake.js&#10;- src/components/global/GamePixiOverlay.vue&#10;- src/components/global/AnimatableElementContainer.vue（直接移除或留空壳）&#10;- src/renderers/effects/*（全部改写为 Three 版）&#10;- 依赖移除：pixi.js、html2canvas、@zumer/snapdom&#10;- 旧效果 Watcher：disabledEffectWatcher.js、cooldownEffectWatcher.js（逻辑迁入新 EffectSystem）&#10;&#10;## 新目录结构（目标）&#10;```&#10;src/three/&#10;  core/ThreeRoot.js&#10;  core/PassStack.js&#10;  ecs/EntityStore.js&#10;  ecs/components/Card.js&#10;  ecs/components/Unit.js&#10;  ecs/systems/AnimationRuntime.js&#10;  ecs/systems/EffectSystem.js&#10;  ecs/systems/ParticleSystem.js&#10;  materials/CardMaterial.js&#10;  materials/Effects/*&#10;  particles/emitters/BasicEmitter.js&#10;  text/TextFactory.js&#10;  shaders/card/* (card base, glow, dissolve)&#10;  shaders/post/* (bloom, distor, vignette)&#10;```&#10;&#10;## 实体与系统（简化 ECS）&#10;- Components: Transform, CardVisual, TextLabel, Cooldown, Highlight, Disabled, ParticleEmitter。&#10;- Systems 每帧：AnimationRuntime → EffectSystem → ParticleSystem → Render。&#10;&#10;## 动画策略（去 GSAP，内置 tween 池）&#10;- addTween({ entity, prop: 'position.x', from, to, duration, ease })。&#10;- 对象池 + 帧内线性扫描；并行动画合并为批函数，减少分配与回调成本。&#10;&#10;## Dissolve/Burn Shader 要点&#10;- 噪声纹理 + 进度 uProgress 控制 discard；边缘发光叠加；uTime 驱动闪烁/扰动。&#10;&#10;## 中文文本快速占位策略&#10;1. 第一步：英文/数字优先；中文先用位图贴图（离线导出 PNG）。&#10;2. 第二步：常用汉字 3-5k MSDF；缺字异步补齐。&#10;3. TextFactory.ensureGlyphs(text) 管理延迟加载与替换。&#10;&#10;## 输入/拖拽重写&#10;- Canvas 监听 pointerdown/move/up；Raycaster 拾取卡牌；更新 Transform；释放触发后端事件（不做 DOM fallback）。&#10;&#10;## 粒子系统速成&#10;- CPU 版：positions/velocities/life 数组 + InstancedMesh；后续换 GPUCompute。&#10;- API: emitBurst(type, center, count, options)。&#10;&#10;## 事件映射（快速改造）&#10;- animate-element → AnimationRuntime.enqueue&#10;- overlay:effect:add → EffectSystem.attach(entity, effectName, opts)&#10;- spawn-particles → ParticleSystem.emitBurst&#10;- card-drag-* → 内部 PointerController 处理，不再透传 animator&#10;&#10;## 快捷校验（烟雾测试）&#10;- DevSceneBootstrap：创建 5 张卡+往返 tween+每 2 秒粒子爆发+切换一张卡燃烧；目视稳定且内存无上升。&#10;&#10;## 性能优先级（Big-Bang 下）&#10;1. 先减少依赖与对象创建；&#10;2. renderer.setAnimationLoop + clock.getDelta；&#10;3. Geometry/Material 对象池；&#10;4. 调试阶段关闭后处理，最后接入。&#10;&#10;## 风险（无回退取舍）&#10;- 开发中断：在重构分支上高频 push；&#10;- 文本可读性：临时位图过渡；&#10;- 特效短缺：后期集中补齐；&#10;- 自研 tween bug：写 3 个核心单测（线性/倒序/重入）。&#10;&#10;## Day 1 操作清单（可直接执行）&#10;1. 删除上文列出的文件与依赖；新增 three、troika-three-text。&#10;2. 新建 three/core/ThreeRoot.js，并在 GameApp.vue 挂载（绝对定位 canvas）。&#10;3. 新建 EntityStore，渲染一个红色平面当卡牌。&#10;4. 写最小 tween 管线驱动 position.x 往返。&#10;5. 提交：feat(three): big-bang skeleton。&#10;&#10;## ThreeRoot 最小伪代码&#10;```js&#10;export class ThreeRoot {&#10;  constructor({ domParent }) {&#10;    this.renderer = new WebGLRenderer({ antialias: true, alpha: true });&#10;    this.scene = new Scene();&#10;    this.camera = new OrthographicCamera(0, window.innerWidth, window.innerHeight, 0, -1000, 1000);&#10;    domParent.appendChild(this.renderer.domElement);&#10;    this._loop = this._loop.bind(this);&#10;    this._last = performance.now();&#10;    requestAnimationFrame(this._loop);&#10;  }&#10;  _loop(t){&#10;    const dt = t - this._last; this._last = t;&#10;    // update systems...&#10;    this.renderer.render(this.scene, this.camera);&#10;    requestAnimationFrame(this._loop);&#10;  }&#10;}&#10;```&#10;&#10;## 成功判定（Big-Bang 版）&#10;- 旧渲染/动画相关文件已删除；`grep -i pixi` 为空；&#10;- 可显示 Three 卡牌，支持拖拽与使用事件；&#10;- 至少 1 个特效 + 1 个动画 + 1 个粒子工作；&#10;- Troika 正常显示卡名；&#10;- 包体积减少（移除 Pixi/html2canvas/snapdom）。&#10;&#10;## 下一步&#10;在 F5 之前不优化材质外观；先打通数据/指令/交互，再集中补光照/后处理/特效，避免返工。&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/THREEJS_REFACTOR_PLAN.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/THREEJS_REFACTOR_PLAN.md" />
              <option name="updatedContent" value="# 前端三维与文本渲染全面重构阶段性规划 (Three.js + Troika)&#10;&#10;&gt; 目标：以一次版本迭代在专用重构分支中完成从「Vue + DOM + Pixi 局部覆盖」到「Three.js 场景主导 + Troika 文本 + 少量 Vue HUD/Overlay」的体系化迁移；获得高阶图形能力（全屏后处理 Filter、粒子、平面/拟物光照、卡牌碎裂与扭曲、统一动画与特效调度），同时提升性能与可维护性。&#10;&#10;---&#10;## 0. 现状架构快速审视 (Baseline)&#10;&#10;### 组成&#10;- Vue 作为主框架，路由仅两页：`GameApp` / `DebugApp`。&#10;- 游戏根界面 `GameApp.vue` 组合多层 DOM：Start/Battle/Rest/End 屏 + 对话 + Cutscene + AudioController + 粒子 + Tooltip + AnimatableElementContainer + Pixi Overlay 等。&#10;- 图形：&#10;  - Pixi 用于：&#10;    1. 全屏背景着色器(`GameBackgroundScreen`)。&#10;    2. 卡牌“烘焙后”的贴图层 (`GamePixiOverlay`)，通过 `BakeManager` + `snapdom/html2canvas` 将 DOM SkillCard 克隆为 Texture 再加滤镜特效。&#10;  - DOM 层直接渲染卡牌、状态面板、日志等。&#10;- 动画：&#10;  - `animator.js` 管理 DOM 元素（卡牌/面板）定位与状态：tracking/animating/dragging；使用 GSAP；通过 `getTransformsSnapshotByAdapter('card')` 每帧提供几何快照给 Pixi overlay 对齐。&#10;  - 特效脉冲/滤镜：`renderers/effects` 内多种 state/pulse/anim effect，注入 Pixi.Sprite filters。&#10;  - 指令级动画队列：`animationSequencer` + mitt 事件总线（frontendEventBus）。&#10;- 事件系统：&#10;  - `frontendEventBus` 控制动画、特效、UI 提示、音效播放、粒子生成。&#10;  - `backendEventBus` 驱动逻辑与玩家输入。&#10;- 粒子：当前 DOM 粒子（简单样式对象）通过事件 `spawn-particles` 分发，后续有意迁移到 WebGL。&#10;- 文本：大量普通 DOM 文本 &amp; 中文，未来需统一 Troika Text (MSDF 或 SDF 字形)。&#10;&#10;### 痛点&#10;1. 双层渲染（DOM + Pixi 烘焙）导致：尺寸、更新、滤镜、销毁路径复杂（MutationObserver/ResizeObserver/Bake 队列）。&#10;2. 卡牌与特效动画在 DOM 与 Pixi 之间分裂；需同步 transform snapshot，难以做 3D/扭曲/光照。&#10;3. 全屏高级后处理（屏幕扭曲、辉光、景深、体积光、粒子叠加）受 Pixi 限制；需要更灵活的 Three.js 管线与可组合 Pass。&#10;4. 文本未来需要 3D 布局、曲面贴合、统一抗锯齿与发光；当前 DOM 不易做批量优化。&#10;5. 性能：频繁 DOM 测量 + html2canvas/snapdom 烘焙开销大；滤镜 filter 重建与纹理销毁路径复杂，GC 压力高。&#10;&#10;### 保留的 Vue 层&#10;- 轻逻辑 HUD/Overlay：音频控制按钮、变更日志 (ChangeLog)、可能的玩家输入弹窗 / 简单消息框。它们对 3D 交互要求低，可继续保留 DOM。&#10;&#10;---&#10;## 1. 目标技术栈 &amp; 架构蓝图&#10;&#10;### 技术栈选型&#10;- Three.js：主渲染场景，使用 WebGL2 / WebGPU (未来可选)；自定义渲染循环。&#10;- Troika-Three-Text：高性能文本材质；支持曲面、抗锯齿、距离场；统一内外发光/描边。&#10;- Post-processing：`three/examples/jsm/postprocessing` 或 `postprocessing` 库 + 自定义 Pass (扭曲、色调映射、Bloom、屏幕空间畸变、动态遮罩)。&#10;- 粒子：&#10;  - 简单：InstancedMesh + shader；&#10;  - 高级：GPUComputationRenderer 或基于 transform feedback；&#10;  - 特效库可自研或集成 `threlte/gsap` 组合。&#10;- 动画：统一改为“指令/状态驱动 + 帧内调度”，使用：&#10;  - 低频：GSAP/Custom Tween (保留)；&#10;  - 高频批量：自写属性插值（对象池）。&#10;- 状态 -&gt; 视图：&#10;  - 保留 displayGameState / backendGameState。&#10;  - 新增 `SceneGraphAdapter`：将游戏实体（技能卡、敌人、玩家、粒子群、特效）映射为 Three.js Object3D。&#10;- 事件桥接：继续使用 mitt；新增 `threeEventBus` 或复用 `frontendEventBus`，增加命名空间/前缀区分。&#10;&#10;### 分层示意&#10;```&#10;[Game Logic / backendGameState]&#10;          | (events)&#10;[Display State] --(diff/adapter)--&gt; [SceneGraphAdapter] --&gt; [Three.js Scene]&#10;                                                   |--&gt; [PostProcessing Chain]&#10;                                                   |--&gt; [Particle Systems]&#10;                                                   |--&gt; [Troika Text Nodes]&#10;[Vue HUD Overlays] (Audio / Changelog / Input Dialog)&#10;```&#10;&#10;---&#10;## 2. 分阶段重构路线概览&#10;&#10;| 阶段 | 名称 | 关键产物 | 风险等级 | 可回退性 |&#10;|------|------|----------|----------|---------|&#10;| P0 | 基线与抽象铺垫 | 目录结构、初始化骨架、适配层接口草稿 | 低 | 完全保留旧逻辑 |&#10;| P1 | Three.js 核心舞台接入 | `ThreeRoot`、渲染循环、Resize、基本摄像机 | 低 | 可并行运行 Pixi |&#10;| P2 | 场景实体抽象 (Card/Unit) | `SceneGraphAdapter`、实体生命周期 | 中 | DOM 仍保留 |&#10;| P3 | 卡牌从 DOM-&gt;Three 迁移 (视觉) | CardMesh、材质系统、光照测试 | 高 | 回退到烘焙纹理 Pixi |&#10;| P4 | 动画系统统一 | 新 `AnimationRuntime` 替换 animator 部分路径 | 高 | 暂时双写两套动画 |&#10;| P5 | Troika 文本接入与文本迁移 | TextFactory、字体打包 &amp; 缓存 | 中 | DOM 文本回退 |&#10;| P6 | 粒子 &amp; 特效体系 | ParticleEngine、EffectSpawner | 中 | 非关键逻辑可延后 |&#10;| P7 | 后处理与屏幕特效 | Pass 管线 (Bloom/Distor/Lighting) | 中 | 可按能力逐步启用 |&#10;| P8 | 性能优化 &amp; 资源管线 | 纹理压缩、对象池、剔除、批处理 | 中 | 调优迭代 |&#10;| P9 | 移除 Pixi + DOM 卡牌层 | 删除烘焙路径、清理观察者 | 高 | 一次性切换 |&#10;| P10 | 收束与 QA | 回归测试、文档、指标对比 | 中 | 若性能差可部分回退 |&#10;&#10;---&#10;## 3. 阶段详细规划&#10;&#10;### P0 基线与抽象铺垫&#10;任务:&#10;1. 创建 `src/three/` 目录：`core/ThreeRoot.js`, `adapters/SceneGraphAdapter.js`, `materials/`, `effects/`, `particles/`, `text/`。&#10;2. 定义接口草稿：&#10;   - `registerEntity(type, id, data)` / `updateEntity(id, data)` / `removeEntity(id)`。&#10;   - `AnimationRuntime.enqueue({ targetId, track, from, to, easing, duration, tags })`。&#10;3. 记录现有 animator / sequencer API -&gt; 新接口映射表。&#10;4. 不修改现有 Pixi 与 DOM，先跑空场景。&#10;验收:&#10;- ThreeRoot 可以 init &amp; dispose，不干扰现有 UI。&#10;- 文档：`THREEJS_REFACTOR_PLAN.md`（即本文件）。&#10;&#10;### P1 接入 Three.js 核心舞台&#10;任务:&#10;1. ThreeRoot：&#10;   - 创建 Renderer (WebGL2)、Scene、Camera (Orthographic for 2D card plane + Perspective for 3D 特效)。&#10;   - 双摄像机或单摄像机 + 分层 (`scene.backgroundLayer`, `scene.mainLayer`).&#10;2. Resize 处理：DPR 适配、viewport 尺寸更新。&#10;3. 渲染循环：自定义 `tick(delta)`，与 Vue 生命周期解耦；控制器：`requestAnimationFrame` + 可暂停。&#10;4. Debug：stats 面板 (optional)。&#10;5. 暂存 PostProcessing 管线占位。&#10;验收:&#10;- 页面加载出现透明 canvas，不遮挡 DOM；F12 中可看到渲染循环日志。&#10;&#10;### P2 场景实体抽象&#10;任务:&#10;1. 设计实体类型：`Card`, `Unit`, `ParticleEmitter`, `Effect`。&#10;2. Card 基础结构：占位平面 (PlaneGeometry) + 占位材质。&#10;3. `SceneGraphAdapter`:&#10;   - 从 displayGameState.player.skills 构建 Card 实体。&#10;   - Diff 算法：新建 / 更新（位置、可见性） / 删除。&#10;4. 位置/布局：暂时沿用 DOM animator 产生的位置（通过 snapshot）→ 将 snapshot 映射为实体 transform；并验证精准对齐。&#10;5. 建立数据绑定：&#10;   - 监听 `frontendEventBus` 的 `card-content-updated` 等事件，暂不烘焙内容，仅更新占位颜色/标识。&#10;验收:&#10;- Three 场景中有与前端 DOM 等量卡牌占位方块，位置对齐误差 &lt; 1px。&#10;&#10;### P3 卡牌视觉迁移&#10;任务:&#10;1. 材质设计：&#10;   - 基础卡框 + 前景图层 + 盾牌/元素图标 → 使用多贴图(UV)或多 Mesh 合并 Instanced；&#10;   - 引入纹理打包器（预处理 png 到 atlas）。&#10;2. 图层与深度：使用 z-index 逻辑映射为 `renderOrder` 或层级；实现 hover 提升。&#10;3. 特效占位：Glow / Outline ShaderMaterial。&#10;4. 临时策略：并行保留 DOM SkillCard；Three 中逐步启用真实材质，当某张卡被标记“migrated”时隐藏 DOM 对应元素。&#10;5. 构建 `CardVisualState`：包含 (cost, rarity, highlight, disabled, cooldownProgress)。&#10;验收:&#10;- 至少 1 种卡牌在 Three 中完整渲染（包含文字占位）。&#10;- 可手动切换某张卡牌 DOM/Three 视图 (debug flag)。&#10;&#10;### P4 动画系统统一&#10;任务:&#10;1. 重新实现 animator 核心：`AnimationRuntime`：&#10;   - 状态机 (idle / tracking / animating / dragging)。&#10;   - tracking 使用插值缓动，去除 quickTo 依赖（可选保留 GSAP fallback）。&#10;2. 替换 snapshot 流程：由 DOM → Three 变为 直接在实体 transform 上操作。&#10;3. 桥接 `animationSequencer`：将 `animate-element` 转为对实体属性的 tween；`animate-element-effect` 转为特效组件激活。保持事件 ID 完成反馈。&#10;4. 拖拽：Raycaster + pointer 交互拾取；从 DOM `mousedown` 改为 canvas 事件。&#10;5. 渐进迁移：保留旧 animator 只处理尚未迁移的 DOM 元素；新 animator 处理 Three 实体。建立“来源路由”判断。&#10;验收:&#10;- 对迁移卡牌执行动画指令，无需 DOM snapshot；完成回调正常。&#10;&#10;### P5 Troika 文本接入&#10;任务:&#10;1. 字体准备：中文/英文混排需要生成 SDF；建立字体打包与预加载；多权重策略或统一粗体合成。&#10;2. 封装 `TextFactory.create({ text, style, layout })` 返回 Troika `Mesh`。&#10;3. 卡牌文字层：名字、描述、数值（cost, AP）全部用 Troika；支持自动换行与宽度约束。&#10;4. Tooltip &amp; FloatingTooltip：原 DOM 方案 → Three 层 (可延后)。保留关键 UI DOM 以避免复杂输入法问题。&#10;5. 性能：文本修改脏标记 → 延迟更新。批量更新时合并。&#10;验收:&#10;- 卡牌名称与费用使用 Troika，渲染清晰；文本更新延迟 &lt; 100ms。&#10;&#10;### P6 粒子 &amp; 特效体系&#10;任务:&#10;1. 设计 `ParticleEngine`：&#10;   - Emitter 描述：速率 / 生命周期 / 初速度分布 / 重力 / 拖拽 / 着色 / 淡入淡出。&#10;   - 实现 CPU → InstancedMesh 初版；后续升级 GPU。 &#10;2. 将现有 `spawn-particles` 事件映射到新的粒子系统；DOM 雪花改为 Three 粒子。&#10;3. 特效：当前 `effects` (pulse/state/anim) 滤镜 → ShaderPass / 材质 uniforms；重写 `makeEffect(name)` 使其返回可附加的组件。&#10;4. 卡牌特效（燃烧/冷却闪光）改写：使用自定义 Shader 或 Sprite+Additive。&#10;验收:&#10;- 至少实现雪花 + 释放技能两类粒子。&#10;- 旧事件触发新粒子，无 DOM 元素参与。&#10;&#10;### P7 后处理与屏幕空间特效&#10;任务:&#10;1. 引入 EffectComposer；Pass 顺序：Render → Bloom → Distortion → Vignette → FXAA。&#10;2. 实现全屏扭曲（根据时间与事件触发 amplitude），可扩展为受技能影响的空间波动。&#10;3. 添加光照测试：DirectionalLight + AmbientLight；卡牌简单法线贴图模拟压印效果。&#10;4. 规划将来平面光照：使用自定义材质 + LightMap / 或延迟渲染简化版。&#10;验收:&#10;- 可动态调节 Bloom/Distortion；性能统计稳定。&#10;&#10;### P8 性能与资源管线优化&#10;任务:&#10;1. 纹理：KTX2 压缩 (BasisU)；延迟加载非关键贴图；预热字体 glyph。&#10;2. 对象池：粒子、特效、临时几何与材质重用。&#10;3. 剔除：视口外或透明/不可见卡牌暂停更新；粒子系统超距销毁。&#10;4. 动画批：多卡牌同步移动时合并缓动数据，减少 tween 实例。&#10;5. Profile：GPU 时间、CPU 帧时间、内存占用对比旧版。&#10;验收:&#10;- 帧率 &gt;= 58 FPS (目标 60) 在目标机器；内存无明显泄漏。&#10;&#10;### P9 移除 Pixi 与 DOM 卡牌烘焙&#10;任务:&#10;1. 删除 `GamePixiOverlay.vue`、`BakeManager`、`domBake.js`、所有 `overlay:effect:*` 事件处理。&#10;2. 移除 `AnimatableElementContainer` 中的 DOM 卡牌渲染与注册逻辑；残留的 MutationObserver/ResizeObserver 清理。&#10;3. animator.js 淘汰或精简只保留全局锚点（若仍用于少量 DOM Overlay）。&#10;4. renderers/effects 重写/替换为 Three 版；废弃 Pixi filters。&#10;5. Vite 构建剔除 html2canvas, snapdom, pixi.js 依赖；更新包体积评估。&#10;验收:&#10;- 页面运行不再引入 Pixi；卡牌完全 Three 渲染；所有特效事件得到响应。&#10;&#10;### P10 收束与 QA&#10;任务:&#10;1. 回归测试：战斗流程、休整、商店、技能使用、激活技能、点击/拖拽、提示、音效、输入控制。&#10;2. 视觉对齐：与旧版截图差异比对（颜色/大小/动画时序）。&#10;3. 性能基线报告：首帧时间、交互帧耗、内存快照、包大小。&#10;4. 文档：开发者指南（如何新增一个卡牌特效/粒子/文本组件）。&#10;5. 清理 TODO / FIXME 注释；标记后续拓展 (WebGPU, ECS)。&#10;验收:&#10;- 所有回归用例通过；性能指标达标；文档齐备。&#10;&#10;---&#10;## 4. 组件/模块迁移映射&#10;&#10;| 现有组件/文件 | 新位置/替代 | 说明 |&#10;|---------------|------------|------|&#10;| GameBackgroundScreen (Pixi) | `three/effects/BackgroundPass.js` | 使用全屏 Quad + ShaderMaterial 或 PostProcess Pass |&#10;| GamePixiOverlay | (淘汰) → CardMesh 集合 | 卡牌直接为 Object3D，不再烘焙 DOM |&#10;| AnimatableElementContainer | `three/adapters/SceneGraphAdapter` | 注册/更新卡牌实体；DOM wrapper 移除 |&#10;| animator.js | `three/animation/AnimationRuntime.js` | 状态机 + tween/插值；锚点策略延续 |&#10;| renderers/effects/* | `three/effects/` + shader | 按 kind 重写：state/pulse/anim 对应材质或后处理参数 |&#10;| ParticleEffectManager (DOM) | `three/particles/ParticleEngine.js` | 实体发射器管理 |&#10;| FloatingTooltip / FloatingCardTooltip | (阶段性) → Troika Text + Sprite 背景 | 可延后保留 DOM |&#10;| html2canvas / snapdom | 移除 | 不再烘焙 DOM |&#10;| AudioControllerScreen / Changelog | 保留 Vue DOM | 与 Three 层平行 |&#10;&#10;---&#10;## 5. 动画与指令迁移设计&#10;&#10;### 当前指令流&#10;`animationSequencer.enqueueInstruction` → 在 `start` 回调里 emit front-end events → animator.js / Pixi overlay 响应 → 完成后 emit 'animation-instruction-finished'.&#10;&#10;### 新模型&#10;```&#10;Sequencer → AnimationRuntime.enqueue(tweenSpec) → AnimationRuntime 内部管理时间线 → onComplete → Sequencer.finish(id)&#10;```&#10;- 仍保留事件桥接（兼容未迁移指令）。&#10;- 特效指令：`effect:add` → `EffectManager.attach(id, effectSpec)` → effectSpec 管理 uniforms 生命周期。&#10;&#10;### 状态机转换&#10;- tracking：实体带有 `targetAnchor`，每帧插值或缓动；支持在 anchor 更新时平滑微调。&#10;- animating：占用该实体的主通道；阻塞 tracking。&#10;- dragging：鼠标拾取 → 暂停 tracking → 更新 transform；释放后平滑回归。&#10;&#10;---&#10;## 6. Troika 文本迁移策略&#10;&#10;1. 字体构建：使用 `msdf-gen` 或 offline 工具生成中文子集；策略：常用汉字 + 技能描述扩展；后续动态补字。&#10;2. TextFactory：缓存材质与 GlyphAtlas；多行布局由 Troika 内部支持，设置 `maxWidth`。&#10;3. 描边/高亮：统一由 shader uniforms 控制，减少多个 DOM span。 &#10;4. 更新策略：技能描述变化时标记脏，集中在一帧末尾刷新。&#10;5. 性能：避免频繁销毁/新建 Mesh；复用对象池；可采用 `textMesh.visible=false` 代替移除。&#10;&#10;---&#10;## 7. 粒子与特效管线概述&#10;&#10;### 粒子&#10;- 数据结构：`ParticleEmitter { shape, rate, burst, life, material, update(delta) }`。&#10;- 渲染：InstancedMesh 更新 instanceMatrix 与颜色数据；GPU 优化阶段使用纹理缓冲+着色器计算。&#10;&#10;### 卡牌特效&#10;- 状态效果 (disabled/highlight)：材质多通道 (baseColor + overlayColor + grayscale toggle)。&#10;- 脉冲效果 (cooldown/flash)：使用时间 uniform 在材质中驱动 emissive/intensity。&#10;- 动画效果 (hit/burn)：hit = scale/rotation jitter + shader flash；burn = dissolve shader（噪声纹理 + alpha clip）。&#10;&#10;### 全屏效果&#10;- Bloom：后处理 Pass；&#10;- Distortion：屏幕空间 uv 扭曲；&#10;- Vignette / Grain：轻量 fragment 叠加；&#10;&#10;---&#10;## 8. 性能监控与指标&#10;&#10;| 指标 | 旧架构目标值 | 新架构期望值 |&#10;|------|--------------|--------------|&#10;| 首次交互可用 (FMP) | ~1.5s | ≤1.2s |&#10;| 平均帧时间 | ~20ms | ≤16.7ms (60FPS) |&#10;| 低端机纹理内存 | 不可控 (DOM 烘焙) | 控制在 &lt; 120MB |&#10;| 粒子峰值 | ~200 简单 DOM | ≥2000 GPU/Instanced |&#10;| 包体积 (生产) | baseline | - 减少 Pixi/html2canvas 依赖 |&#10;&#10;监控工具：&#10;- 自定义 Stats Overlay (CPU/GPU/DrawCalls)。&#10;- 定期打印 `SceneGraphAdapter` 实体数量与对象池命中率。&#10;&#10;---&#10;## 9. 风险与缓解&#10;&#10;| 风险 | 描述 | 缓解策略 |&#10;|------|------|----------|&#10;| 中文字体体积过大 | 全字库 MSDF 过重 | 子集提取 + 动态补字 + 分层缓存 |&#10;| 动画指令竞态 | 新旧 Animator 双写产生冲突 | 设定迁移标记 `source=three`，Sequencer 路由至对应运行时 |&#10;| 拖拽拾取精度 | Canvas 事件与对象拾取不稳定 | 使用 Raycaster + 屏幕空间 bounding 合并判定 |&#10;| 粒子性能 | CPU 粒子导致掉帧 | 尽早引入 Instanced，逐步 GPU 化 |&#10;| 迁移跨度大 | 一次性替换失败风险高 | 保持阶段性启用开关 (feature flags) |&#10;| 文本排版差异 | DOM 与 Troika 换行/内边距不同 | 校准 lineHeight / anchor 偏移表；提供兼容模式参数 |&#10;&#10;---&#10;## 10. 回退策略与 Feature Flag&#10;&#10;- `ENABLE_THREE_SCENE`：主场景启用/禁用。&#10;- `ENABLE_THREE_CARDS`：卡牌视觉是否使用 Three。&#10;- `ENABLE_TROIKA_TEXT`：文字是否切换到 Troika。&#10;- `ENABLE_THREE_PARTICLES`：粒子系统开关。&#10;- `ENABLE_POSTPROCESSING`：后处理启用/关闭。&#10;&#10;所有改动在阶段性合并时与这些 flag 绑定；出现重大问题可在分支中快速关闭。最终 P9 前清理。&#10;&#10;---&#10;## 11. 交付物与文档结构规划&#10;&#10;新增文档：&#10;- `docs/architecture/three-root.md`：ThreeRoot 初始化与销毁流程。&#10;- `docs/animation/runtime.md`：AnimationRuntime API 与状态机说明。&#10;- `docs/effects/card-effects.md`：卡牌特效设计与 shader 参数。&#10;- `docs/text/troika.md`：字体构建与 TextFactory 规范。&#10;- `docs/perf/metrics.md`：性能指标与监控脚本。&#10;&#10;---&#10;## 12. 下一步立即行动 (P0→P1 Sprint 列表)&#10;&#10;短期执行清单：&#10;1. 建立 `src/three/` 目录与骨架文件 (空实现)。&#10;2. ThreeRoot 初始化：渲染器/场景/摄像机/循环。挂载在 `GameApp` 中 Pixi 背景之上或替换它。暂不移除 Pixi。&#10;3. 提供最小 `registerEntity` 与 `updateLoop` 日志输出。&#10;4. 添加 Feature Flag (例如全局变量或环境变量)。&#10;5. 编写开发者指南：如何启用/禁用 Three 场景。&#10;&#10;完成后再进入 P2。&#10;&#10;---&#10;## 13. 成功判定 (Definition of Done)&#10;&#10;最终版本：&#10;- 不依赖 Pixi/html2canvas/snapdom；卡牌、粒子、全屏特效、文本全部由 Three + Troika 驱动。&#10;- 游戏所有核心交互（战斗、技能使用、休整购买、能力选择）功能与旧版无功能偏差。&#10;- 新增视觉能力：至少 1 个自定义卡牌碎裂/燃烧 dissolve shader；1 个全屏扭曲；1 个粒子爆发效果。&#10;- 性能基线达到预期（主机与低端机指标）。&#10;- 文档完整，可支持新增技能卡特效无需阅读旧 DOM/Pixi 代码。&#10;&#10;---&#10;## 14. 参考与后续拓展&#10;&#10;后续可探索：&#10;- WebGPU 渲染路径（R3F 或原生 three-gpu 支持）。&#10;- ECS 框架（bitecs）重构 SceneGraphAdapter 内部数据结构。&#10;- GPU 粒子：Compute Shader / transform feedback。&#10;- 动态阴影 / SSAO / SSGI 用于更沉浸的光照表现。&#10;&#10;---&#10;**附注**：本计划为“单次版本重构”设计，但强烈建议在执行中仍通过 feature flags 与阶段合并维持代码库可运行，避免巨大 PR 难以审阅与回退。若时间风险上升，可将卡牌材质高级特效 / dissolve / 粒子 GPU 化列入后续版本。&#10;&#10;---&#10;&gt; 最终请在开始 P1 前创建骨架并添加 Feature Flag，随后以小步合并验证渲染循环稳定性。祝重构顺利！&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>